<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Douglas Bates and Claudia Solis-Lemus">
<meta name="dcterms.date" content="2022-07-10">

<title>Julia Workshop - Session 2b: Determining Interval Overlap</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link id="quarto-text-highlighting-styles" href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Julia Workshop</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html">Home</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html">About</a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/crsl4/julia-workshop"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#strategy-for-computing-overlaps" id="toc-strategy-for-computing-overlaps" class="nav-link active" data-scroll-target="#strategy-for-computing-overlaps">Strategy for computing overlaps</a>
  <ul class="collapse">
  <li><a href="#creating-dictionaries-of-vectorunitrange" id="toc-creating-dictionaries-of-vectorunitrange" class="nav-link" data-scroll-target="#creating-dictionaries-of-vectorunitrange">Creating dictionaries of Vector{UnitRange}</a></li>
  </ul></li>
  <li><a href="#intersecting-reference-ranges-with-a-target" id="toc-intersecting-reference-ranges-with-a-target" class="nav-link" data-scroll-target="#intersecting-reference-ranges-with-a-target">Intersecting reference ranges with a target</a></li>
  <li><a href="#create-dictionaries-of-rangetrees-and-intervaltrees" id="toc-create-dictionaries-of-rangetrees-and-intervaltrees" class="nav-link" data-scroll-target="#create-dictionaries-of-rangetrees-and-intervaltrees">Create dictionaries of RangeTrees and IntervalTrees</a>
  <ul class="collapse">
  <li><a href="#rangetrees" id="toc-rangetrees" class="nav-link" data-scroll-target="#rangetrees">RangeTrees</a></li>
  <li><a href="#intervaltrees" id="toc-intervaltrees" class="nav-link" data-scroll-target="#intervaltrees">IntervalTrees</a></li>
  </ul></li>
  <li><a href="#time-for-a-shootout" id="toc-time-for-a-shootout" class="nav-link" data-scroll-target="#time-for-a-shootout">Time for a shootout</a>
  <ul class="collapse">
  <li><a href="#vectorunitrange" id="toc-vectorunitrange" class="nav-link" data-scroll-target="#vectorunitrange">Vector{UnitRange}</a></li>
  <li><a href="#rangetree" id="toc-rangetree" class="nav-link" data-scroll-target="#rangetree">RangeTree</a></li>
  <li><a href="#intervaltree" id="toc-intervaltree" class="nav-link" data-scroll-target="#intervaltree">IntervalTree</a></li>
  </ul></li>
  <li><a href="#determining-coverage" id="toc-determining-coverage" class="nav-link" data-scroll-target="#determining-coverage">Determining coverage</a></li>
  <li><a href="#iterating-over-a-set-of-targets" id="toc-iterating-over-a-set-of-targets" class="nav-link" data-scroll-target="#iterating-over-a-set-of-targets">Iterating over a set of targets</a></li>
  <li><a href="#the-whole-shootin-match" id="toc-the-whole-shootin-match" class="nav-link" data-scroll-target="#the-whole-shootin-match">The whole shootin’ match</a></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions">Conclusions</a></li>
  <li><a href="#version-information" id="toc-version-information" class="nav-link" data-scroll-target="#version-information">Version information</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/crsl4/julia-workshop/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Session 2b: Determining Interval Overlap</h1>
</div>





<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Douglas Bates and Claudia Solis-Lemus </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2022-07-10</p>
    </div>
  </div>
    
  </div>
  

</header>

<p>Load packages to be used</p>
<div class="cell" data-execution_count="1">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Arrow          </span><span class="co"># Arrow storage and file format</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">BenchmarkTools </span><span class="co"># tools for benchmarking code</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">DataFrames     </span><span class="co"># versatile tabular data format</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">IntervalTrees  </span><span class="co"># interval trees from BioJulia</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Random         </span><span class="co"># random number generation tools</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">RangeTrees     </span><span class="co"># a bespoke implementation of interval trees</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Tables         </span><span class="co"># row- or column-oriented tabular data</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Base.intersect  </span><span class="co"># will create new methods for these generics</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Base.intersect!</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>datadir <span class="op">=</span> <span class="st">"biofast-data-v1"</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="strategy-for-computing-overlaps" class="level2">
<h2 class="anchored" data-anchor-id="strategy-for-computing-overlaps">Strategy for computing overlaps</h2>
<ul>
<li>Split the data in the Arrow data tables by chromosome tag and convert the <code>start-stop</code> pairs to a <code>Vector{UnitRange}</code>. For the reference intervals, sort the vectors by increasing <code>first</code> value.</li>
<li>For the reference intervals create two other dictionaries whose values are <a href="https://github.com/dmbates/RangeTrees.jl"><code>RangeTree</code>s</a> and <a href="https://github.com/BioJulia/IntervalTrees.jl"><code>IntervalTree</code>s</a>, respectively.</li>
<li>Benchmark the intersection with a target <code>UnitRange</code> from each of the representations of the reference ranges. Do this in two ways: <code>intersect</code>, which allocates the storage for the result, and <code>intersect!</code>, which modifies one of its arguments.</li>
<li>Compute the coverage from the vector of intersections.</li>
<li>Apply the methods to the complete set of targets.</li>
</ul>
<section id="creating-dictionaries-of-vectorunitrange" class="level3">
<h3 class="anchored" data-anchor-id="creating-dictionaries-of-vectorunitrange">Creating dictionaries of Vector{UnitRange}</h3>
<ul>
<li>A <code>UnitRange</code>, like <code>2:10</code>, includes the end points (accessed as <code>first</code> and <code>last</code>).</li>
</ul>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(<span class="fl">2</span><span class="op">:</span><span class="fl">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>UnitRange{Int64}</code></pre>
</div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fl">2</span><span class="op">:</span><span class="fl">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>9</code></pre>
</div>
</div>
<ul>
<li>The positions in the <code>start</code> and <code>stop</code> columns in a <code>.bed</code> are not both included in the interval represented. The positions correspond to the interval <code>start:(stop - 1)</code> as 0-based positions or <code>(start + 1):stop</code> in 1-based positions.</li>
<li>It doesn’t matter which one we use as long as we are consistent.</li>
<li>We will start counting from 1, just like <a href="https://en.wikipedia.org/wiki/Count_von_Count">world’s greatest expert on counting</a> does.</li>
<li>We wrap this conversion in a utility function to help ensure consistency.</li>
</ul>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">asrange</span>(start, stop) <span class="op">=</span> (start <span class="op">+</span> <span class="fu">one</span>(start))<span class="op">:</span>stop</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>asrange (generic function with 1 method)</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>one(x)</code> is used instead of the literal <code>1</code> in <code>asrange</code> to preserve the integer type (see also <code>?oneunit</code>, which is slighly more general).</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>st <span class="op">=</span> <span class="fu">Int32</span>(<span class="fl">2314</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(st <span class="op">+</span> <span class="fl">1</span>)       <span class="co"># type gets promoted to Int64</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>Int64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(st <span class="op">+</span> <span class="fu">one</span>(st)) <span class="co"># type not promoted</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>Int32</code></pre>
</div>
</div>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This method definition uses the compact “one-liner” form.</p>
</div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">datatable</span>(fnroot<span class="op">::</span><span class="dt">AbstractString</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">DataFrame</span>(Arrow.<span class="fu">Table</span>(<span class="fu">joinpath</span>(datadir, <span class="st">"</span><span class="sc">$</span>fnroot<span class="st">.arrow"</span>)))</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">chromodict</span>(df<span class="op">::</span><span class="dt">DataFrame</span>; sorted<span class="op">::</span><span class="dt">Bool</span>=<span class="cn">false</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  T <span class="op">=</span> <span class="fu">eltype</span>(df.start)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  vtype <span class="op">=</span> <span class="dt">Vector</span>{<span class="dt">UnitRange</span>{T}}</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  dict <span class="op">=</span> <span class="fu">Dict</span><span class="dt">{Symbol, vtype}</span>()</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> r <span class="kw">in</span> <span class="fu">rowtable</span>(sorted ? <span class="fu">sort</span>(df) <span class="op">:</span> df)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    (; chromo, start, stop) <span class="op">=</span> r</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">push!</span>(<span class="fu">get!</span>(dict, <span class="fu">Symbol</span>(chromo), <span class="fu">vtype</span>()), <span class="fu">asrange</span>(start, stop))</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> dict</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>annorangevecs <span class="op">=</span> <span class="fu">chromodict</span>(<span class="fu">datatable</span>(<span class="st">"ex-anno"</span>); sorted<span class="op">=</span><span class="cn">true</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>Dict{Symbol, Vector{UnitRange{Int32}}} with 24 entries:
  :chr21 =&gt; [5011799:5011874, 5012548:5012687, 5014386:5014471, 5016935:5017145…
  :chr15 =&gt; [19878555:19878668, 19878831:19879004, 19881201:19881307, 19882277:…
  :chr10 =&gt; [14061:14299, 14138:14299, 14497:14604, 16502:16544, 44712:44901, 4…
  :chr17 =&gt; [64099:65736, 65830:65887, 71366:71556, 75814:75878, 76723:76866, 8…
  :chr07 =&gt; [12704:12822, 19018:19172, 19619:19895, 20834:21029, 24314:24365, 2…
  :chr14 =&gt; [16057472:16057622, 18333726:18333900, 18333826:18333896, 18337973:…
  :chr08 =&gt; [64091:64175, 64269:64320, 72601:72673, 72617:72701, 78905:79244, 7…
  :chr12 =&gt; [12310:12358, 12740:12824, 13102:13201, 13370:13501, 14522:14944, 1…
  :chr18 =&gt; [11103:11595, 11191:11595, 13152:13354, 14195:14653, 14490:14653, 1…
  :chrX  =&gt; [253743:253846, 254937:255091, 276322:276394, 276324:276394, 276353…
  :chr13 =&gt; [18174010:18174103, 18174442:18174512, 18176018:18176170, 18177555:…
  :chr11 =&gt; [75780:76143, 86649:87586, 112967:113111, 113116:113174, 121258:121…
  :chr22 =&gt; [10736171:10736283, 10939388:10939423, 10940597:10940707, 10941691:…
  :chr03 =&gt; [23757:23812, 23968:24501, 53348:53692, 54293:54346, 195758:195914,…
  :chr19 =&gt; [60951:61894, 62113:66524, 63821:64213, 65051:65226, 65822:66047, 6…
  :chr05 =&gt; [58198:58915, 92151:92276, 113251:113448, 139483:140716, 140258:140…
  :chr06 =&gt; [95124:95454, 105919:106856, 131910:132117, 140211:140379, 142272:1…
  :chr20 =&gt; [87250:87359, 87710:87767, 96005:96533, 96005:97094, 142369:142686,…
  :chrY  =&gt; [2784749:2784853, 2786855:2787699, 2789827:2790328, 2827982:2828218…
  :chr04 =&gt; [49096:49956, 49554:50124, 53285:53491, 53286:53491, 53295:53491, 5…
  :chr02 =&gt; [38814:41627, 41220:41627, 41221:41627, 42809:42952, 45440:46385, 4…
  :chr01 =&gt; [11869:12227, 12010:12057, 12179:12227, 12613:12697, 12613:12721, 1…
  :chr09 =&gt; [12134:12190, 12291:12340, 12726:12834, 13088:13157, 13338:13487, 1…
  :chr16 =&gt; [11555:11908, 11861:11908, 12294:12378, 12294:12402, 12663:12733, 1…</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The call <code>get!(dict, Symbol(chromo), vtype())</code> in <code>chromodict</code> returns <code>dict[Symbol(chromo)]</code> or the default value, which is an empty <code>Vector{UnitRange{T}}</code>. For the case of the default, it also installs that key/value pair in <code>dict</code>.</p>
</div>
</div>
<ul>
<li>Do the same for the <code>"ex-rna"</code> intervals but don’t sort the vectors for each chromosome.</li>
</ul>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>rnarangevecs <span class="op">=</span> <span class="fu">chromodict</span>(<span class="fu">datatable</span>(<span class="st">"ex-rna"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>Dict{Symbol, Vector{UnitRange{Int32}}} with 24 entries:
  :chr21 =&gt; [8212585:8212728, 8207701:8252389, 8256795:8256941, 46189146:461895…
  :chr15 =&gt; [55181315:55196932, 82536758:82540239, 82372221:82372895, 44711528:…
  :chr10 =&gt; [80155591:80169336, 50305605:50306118, 96750280:96750926, 97426203:…
  :chr17 =&gt; [76270412:76271290, 16031524:16031722, 1857276:1857405, 29551138:29…
  :chr14 =&gt; [105487209:105488788, 98972821:98973068, 105854220:105855113, 49583…
  :chr12 =&gt; [56712431:56713192, 56712433:56724523, 22046215:22065551, 106973811…
  :chr8  =&gt; [98041721:98045534, 144789769:144792143, 78732767:78733310, 9804172…
  :chr18 =&gt; [55225981:55226732, 59903931:59904296, 59904022:59904292, 49043832:…
  :chr4  =&gt; [102753381:102760907, 108620586:108625247, 108650646:108667810, 108…
  :chr9  =&gt; [19376352:19379531, 133019443:133021168, 19376255:19380216, 1102440…
  :chr7  =&gt; [101239612:101245071, 5527161:5529285, 73569680:73572887, 5527151:5…
  :chrX  =&gt; [72272603:72277210, 119786512:119791605, 77826515:77829079, 7924198…
  :chr13 =&gt; [45337229:45341160, 98452159:98452832, 20403667:20525839, 45337254:…
  :chr11 =&gt; [63974632:63976540, 809990:812856, 809978:812873, 16974643:16975031…
  :chr22 =&gt; [41515512:41528974, 38483442:38483648, 35838275:35838675, 23894420:…
  :chr3  =&gt; [193658960:193694726, 135162156:135260466, 197954049:197955808, 191…
  :chr19 =&gt; [49487627:49491841, 51989732:51989996, 41860787:41871398, 5690502:5…
  :chr6  =&gt; [31268757:31272069, 73517516:73521019, 73517515:73520059, 29942543:…
  :chr5  =&gt; [170083215:170083368, 150444238:150445661, 40832456:40834607, 17814…
  :chr20 =&gt; [62388308:62388509, 57408568:57409306, 21166171:21166419, 23633657:…
  :chrY  =&gt; [13286599:13287476, 13286598:13287541, 13286599:13287542, 13286648:…
  :chr2  =&gt; [216499332:216501458, 216499269:216501462, 55232807:55235607, 20288…
  :chr16 =&gt; [84565612:84566066, 2770366:2771406, 24094163:24220605, 56608601:56…
  :chr1  =&gt; [165655371:165655620, 84498368:84506172, 44777749:44778638, 2369261…</code></pre>
</div>
</div>
<ul>
<li>We will use the intervals on chromsome 21 for our timing benchmarks. The target for tests of intersection with a single target interval will be the last interval on chromosome 21 in “ex-rna.arrow”.</li>
</ul>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>rangevec21 <span class="op">=</span> annorangevecs[<span class="op">:</span>chr21]</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>rnarange21 <span class="op">=</span> rnarangevecs[<span class="op">:</span>chr21]</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>target <span class="op">=</span> <span class="fu">last</span>(rnarange21)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>31659713:31668660</code></pre>
</div>
</div>
</section>
</section>
<section id="intersecting-reference-ranges-with-a-target" class="level2">
<h2 class="anchored" data-anchor-id="intersecting-reference-ranges-with-a-target">Intersecting reference ranges with a target</h2>
<ul>
<li><p>Create a method to intersect a target interval with a <code>Vector{UnitRange}</code> returning the intersections as another <code>Vector{UnitRange}</code>.</p></li>
<li><p>A common Julia programming idiom for such cases is to create two methods: one for <code>intersect!</code>, which modifies an argument that will hold the result, and one for <code>intersect</code>, which allocates the result then calls the <code>intersect!</code> method.</p></li>
<li><p>For the <code>intersect!</code> method we first <code>empty!</code> the result vector, which zeros the vector length but does not shrink the memory chunk allocated to the vector, then <code>push!</code> intersections onto it. If there are many calls to an <code>intersect!</code> method like this only a few will cause memory allocations.</p></li>
<li><p>The elements of our vectors of reference intervals, like <code>rangevec21</code>, are sorted by their <code>first</code> element but the <code>last</code> elements do not have any special relationships. The best we can do to determine all intersections is a sequential scan of the sorted vector of ranges with an early exit when <code>last(target) &lt; first(vectorelement)</code>.</p></li>
</ul>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">intersect!</span>(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  result<span class="op">::</span><span class="dt">Vector{UnitRange{T}}</span>,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  target<span class="op">::</span><span class="dt">AbstractUnitRange{&lt;:Integer}</span>,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  refs<span class="op">::</span><span class="dt">Vector{UnitRange{T}}</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>) <span class="kw">where</span> {T}</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">empty!</span>(result)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  target <span class="op">=</span> <span class="fu">eltype</span>(refs)(target)  <span class="co"># coerce the type, if necessary</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  lastt <span class="op">=</span> <span class="fu">last</span>(target)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> rng <span class="kw">in</span> refs</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    isect <span class="op">=</span> <span class="fu">intersect</span>(target, rng)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    !<span class="fu">isempty</span>(isect) <span class="op">&amp;&amp;</span> <span class="fu">push!</span>(result, isect)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    lastt <span class="op">&lt;</span> <span class="fu">first</span>(rng) <span class="op">&amp;&amp;</span> <span class="cf">break</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">intersect</span>(target<span class="op">::</span><span class="dt">AbstractUnitRange{&lt;:Integer}</span>, refs<span class="op">::</span><span class="dt">Vector{UnitRange{T}}</span>) <span class="kw">where</span> {T}</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">intersect!</span>(<span class="fu">similar</span>(refs, <span class="fl">0</span>), target, refs)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>cachedresult <span class="op">=</span> <span class="fu">intersect</span>(target, rangevec21)  <span class="co"># will use for comparisons</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>12-element Vector{UnitRange{Int32}}:
 31659713:31659841
 31659713:31659784
 31659713:31659841
 31659713:31660708
 31661549:31661734
 31663790:31663886
 31664306:31664482
 31666449:31666518
 31666728:31667247
 31667258:31667341
 31667258:31667375
 31668471:31668660</code></pre>
</div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> <span class="fu">similar</span>(rangevec21, <span class="fl">0</span>)    <span class="co"># working storage</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>cachedresult <span class="op">==</span> <span class="fu">intersect!</span>(result, target, rangevec21)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>true</code></pre>
</div>
</div>
</section>
<section id="create-dictionaries-of-rangetrees-and-intervaltrees" class="level2">
<h2 class="anchored" data-anchor-id="create-dictionaries-of-rangetrees-and-intervaltrees">Create dictionaries of RangeTrees and IntervalTrees</h2>
<section id="rangetrees" class="level3">
<h3 class="anchored" data-anchor-id="rangetrees">RangeTrees</h3>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>annorangetrees <span class="op">=</span> <span class="fu">Dict</span>(k <span class="op">=&gt;</span> <span class="fu">RangeTree</span>(v) <span class="cf">for</span> (k,v) <span class="kw">in</span> annorangevecs)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>rangetree21 <span class="op">=</span> annorangetrees[<span class="op">:</span>chr21]</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print_tree</span>(<span class="fu">IndexNode</span>(rangetree21); maxdepth<span class="op">=</span><span class="fl">3</span>)  <span class="co"># methods from AbstractTrees.jl</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(36058816:36058973, 46691226)
├─ (25933816:25934366, 36058924)
│  ├─ (13958116:13958185, 25928997)
│  │  ├─ (7422603:7422701, 13954150)
│  │  │  ⋮
│  │  │  
│  │  └─ (17604860:17604997, 25928997)
│  │     ⋮
│  │     
│  └─ (32726772:32726917, 36058924)
│     ├─ (29370497:29370973, 32702047)
│     │  ⋮
│     │  
│     └─ (33602267:33602345, 36058924)
│        ⋮
│        
└─ (43007491:43007618, 46691226)
   ├─ (39422988:39423490, 43007515)
   │  ├─ (37267238:37267301, 39423490)
   │  │  ⋮
   │  │  
   │  └─ (41810154:41810466, 43007515)
   │     ⋮
   │     
   └─ (44910284:44910415, 46691226)
      ├─ (44133616:44134154, 44910372)
      │  ⋮
      │  
      └─ (46112804:46112949, 46691226)
         ⋮
         </code></pre>
</div>
</div>
<ul>
<li><p><a href="https://github.com/dmbates/RangeTrees.jl">RangeTrees.jl</a> provides an implementation of <a href="https://en.wikipedia.org/wiki/Interval_tree">interval trees</a> using the <a href="https://en.wikipedia.org/wiki/Interval_tree#Augmented_tree">augmented binary tree</a> formulation.</p></li>
<li><p>This is a balanced, binary tree where nodes contain a <code>UnitRange</code> (sorted by <code>first</code>), the indices of the left and right subtrees, and <code>maxlast</code>, which is the maximum value of the last element in the ranges in the subtree rooted at the node.</p></li>
<li><p>The root of <code>rangetree21</code> is the node at the median index of <code>rangevec21</code>, rounding the position up when the number of intervals is even.</p></li>
</ul>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(rangevec21), <span class="fu">midrange</span>(<span class="fu">eachindex</span>(rangevec21))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>(6518, 3260)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>rangetree21[<span class="fu">midrange</span>(<span class="fu">eachindex</span>(rangetree21))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>RangeNode{Int32}(36058816:36058973, 1630, 4890, 46691226)</code></pre>
</div>
</div>
<ul>
<li>The <code>maxlast</code> value for the root node must be the maximum last position of any of the ranges.</li>
</ul>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">maximum</span>(<span class="fu">last</span>.(rangevec21))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>46691226</code></pre>
</div>
</div>
<ul>
<li>It happens that this value is the same as the last position in the last range but that doesn’t have to be the case. The ranges are sorted by increasing first position, not by last position.</li>
</ul>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">last</span>(<span class="fu">last</span>(rangevec21))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>46691226</code></pre>
</div>
</div>
<ul>
<li><code>intersect</code> and <code>intersect!</code> methods are already defined for <code>RangeTree</code>s.</li>
</ul>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>cachedresult <span class="op">==</span> <span class="fu">intersect</span>(target, rangetree21)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>true</code></pre>
</div>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>cachedresult <span class="op">==</span> <span class="fu">intersect!</span>(result, target, rangetree21)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>true</code></pre>
</div>
</div>
</section>
<section id="intervaltrees" class="level3">
<h3 class="anchored" data-anchor-id="intervaltrees">IntervalTrees</h3>
<ul>
<li>Next create a dictionary with <code>IntervalTree</code> values. This is somewhat tedious to get right so we create a function to hide the details.</li>
</ul>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toitrees</span>(rngdict<span class="op">::</span><span class="dt">Dict{S, Vector{UnitRange{T}}}</span>) <span class="kw">where</span> {S,T}</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">Dict</span>(k <span class="op">=&gt;</span> <span class="fu">IntervalTree</span><span class="dt">{T, Interval{T}}</span>(<span class="fu">Interval</span>.(v)) <span class="cf">for</span> (k,v) <span class="kw">in</span> rngdict)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>annointvltrees <span class="op">=</span> <span class="fu">toitrees</span>(annorangevecs)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>intvltree21 <span class="op">=</span> annointvltrees[<span class="op">:</span>chr21]</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="fu">show</span>(intvltree21)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>IntervalTree{</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Int32, Interval{Int32}}
(5011799,5011874)
(5012548,5012687)
(5014386,5014471)
⋮
(46664295,46665117)
(46664295,46665124)
(46690764,46691226)</code></pre>
</div>
</div>
<ul>
<li>Creating an <code>intersect!</code> method is also tedious because the package has its own <code>Interval</code> data type and it defines <code>intersect(itr::IntervalTree, (frst, lst))</code> to return an iterator of <code>Interval</code>s in the tree, not the intersection</li>
</ul>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Interval</span>(target)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>Interval{Int32}
(31659713,31668660)</code></pre>
</div>
</div>
<ul>
<li>Create an <code>asrange</code> method for the inverse mapping</li>
</ul>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">asrange</span>(intvl<span class="op">::</span><span class="dt">Interval</span>) <span class="op">=</span> <span class="fu">first</span>(intvl)<span class="op">:</span><span class="fu">last</span>(intvl)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">asrange</span>(<span class="fu">Interval</span>(target)) <span class="op">==</span> target   <span class="co"># check it works</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>true</code></pre>
</div>
</div>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">intersect!</span>(res<span class="op">::</span><span class="dt">Vector{UnitRange{T}}</span>, target<span class="op">::</span><span class="dt">AbstractUnitRange</span>, refs<span class="op">::</span><span class="dt">IntervalTree{T}</span>) <span class="kw">where</span> {T}</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">empty!</span>(res)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  firstt, lastt <span class="op">=</span> <span class="fu">first</span>(target), <span class="fu">last</span>(target)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> isect <span class="kw">in</span> <span class="fu">intersect</span>(refs, (firstt, lastt))</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">push!</span>(res, <span class="fu">max</span>(<span class="fu">first</span>(isect), firstt)<span class="op">:</span><span class="fu">min</span>(<span class="fu">last</span>(isect), lastt))</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> res</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>cachedresult <span class="op">==</span> <span class="fu">intersect!</span>(result, target, intvltree21)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>true</code></pre>
</div>
</div>
</section>
</section>
<section id="time-for-a-shootout" class="level2">
<h2 class="anchored" data-anchor-id="time-for-a-shootout">Time for a shootout</h2>
<section id="vectorunitrange" class="level3">
<h3 class="anchored" data-anchor-id="vectorunitrange">Vector{UnitRange}</h3>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">intersect!</span>(res, tar, ref) setup<span class="op">=</span>(res <span class="op">=</span> result; tar <span class="op">=</span> target; ref <span class="op">=</span> rangevec21)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>BenchmarkTools.Trial: 10000 samples with 8 evaluations.
 Range [90m([39m[36m[1mmin[22m[39m … [35mmax[39m[90m):  [39m[36m[1m3.861 μs[22m[39m … [35m 18.141 μs[39m  [90m┊[39m GC [90m([39mmin … max[90m): [39m0.00% … 0.00%
 Time  [90m([39m[34m[1mmedian[22m[39m[90m):     [39m[34m[1m4.220 μs               [22m[39m[90m┊[39m GC [90m([39mmedian[90m):    [39m0.00%
 Time  [90m([39m[32m[1mmean[22m[39m ± [32mσ[39m[90m):   [39m[32m[1m4.372 μs[22m[39m ± [32m885.192 ns[39m  [90m┊[39m GC [90m([39mmean ± σ[90m):  [39m0.00% ± 0.00%

  [39m▅[39m█[39m▅[39m▇[34m█[39m[39m█[32m▄[39m[39m [39m▁[39m [39m [39m▁[39m [39m [39m [39m [39m▁[39m [39m [39m [39m [39m [39m▁[39m [39m▂[39m [39m▂[39m [39m [39m [39m [39m▂[39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m▂
  [39m█[39m█[39m█[39m█[34m█[39m[39m█[32m█[39m[39m▇[39m█[39m█[39m▅[39m█[39m█[39m▁[39m█[39m▃[39m█[39m█[39m█[39m▇[39m▃[39m▅[39m█[39m▇[39m█[39m▇[39m█[39m█[39m█[39m█[39m▇[39m█[39m▅[39m▆[39m▅[39m▆[39m▆[39m▆[39m▆[39m▆[39m▆[39m▅[39m▅[39m▄[39m▅[39m▆[39m▇[39m▆[39m▅[39m▅[39m▅[39m▃[39m▅[39m▄[39m▅[39m▆[39m▅[39m▇[39m▆[39m [39m█
  3.86 μs[90m      [39m[90mHistogram: [39m[90m[1mlog([22m[39m[90mfrequency[39m[90m[1m)[22m[39m[90m by time[39m       8.7 μs [0m[1m&lt;[22m

 Memory estimate[90m: [39m[33m0 bytes[39m, allocs estimate[90m: [39m[33m0[39m.</code></pre>
</div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">intersect</span>(tar, ref) setup<span class="op">=</span>(tar <span class="op">=</span> target; ref <span class="op">=</span> rangevec21)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>BenchmarkTools.Trial: 10000 samples with 8 evaluations.
 Range [90m([39m[36m[1mmin[22m[39m … [35mmax[39m[90m):  [39m[36m[1m4.062 μs[22m[39m … [35m46.902 μs[39m  [90m┊[39m GC [90m([39mmin … max[90m): [39m0.00% … 0.00%
 Time  [90m([39m[34m[1mmedian[22m[39m[90m):     [39m[34m[1m4.474 μs              [22m[39m[90m┊[39m GC [90m([39mmedian[90m):    [39m0.00%
 Time  [90m([39m[32m[1mmean[22m[39m ± [32mσ[39m[90m):   [39m[32m[1m5.015 μs[22m[39m ± [32m 1.967 μs[39m  [90m┊[39m GC [90m([39mmean ± σ[90m):  [39m0.00% ± 0.00%

  [39m▅[39m▇[39m█[34m▆[39m[39m▃[39m▂[32m▁[39m[39m [39m [39m [39m [39m [39m [39m▁[39m▁[39m▁[39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m▁
  [39m█[39m█[39m█[34m█[39m[39m█[39m█[32m█[39m[39m█[39m█[39m█[39m█[39m▇[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m▇[39m█[39m▇[39m▇[39m▇[39m▇[39m▇[39m▇[39m▇[39m▆[39m▇[39m█[39m▇[39m▆[39m▆[39m█[39m█[39m▇[39m▆[39m▆[39m▇[39m▆[39m▇[39m▇[39m▅[39m▆[39m▅[39m▅[39m▅[39m▅[39m▆[39m▆[39m▆[39m▆[39m▅[39m▅[39m▅[39m▅[39m [39m█
  4.06 μs[90m      [39m[90mHistogram: [39m[90m[1mlog([22m[39m[90mfrequency[39m[90m[1m)[22m[39m[90m by time[39m     12.7 μs [0m[1m&lt;[22m

 Memory estimate[90m: [39m[33m480 bytes[39m, allocs estimate[90m: [39m[33m3[39m.</code></pre>
</div>
</div>
</section>
<section id="rangetree" class="level3">
<h3 class="anchored" data-anchor-id="rangetree">RangeTree</h3>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">intersect!</span>(res, tar, ref) setup<span class="op">=</span>(res <span class="op">=</span> result; tar <span class="op">=</span> target; ref <span class="op">=</span> rangetree21)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>BenchmarkTools.Trial: 10000 samples with 540 evaluations.
 Range [90m([39m[36m[1mmin[22m[39m … [35mmax[39m[90m):  [39m[36m[1m194.741 ns[22m[39m … [35m  9.613 μs[39m  [90m┊[39m GC [90m([39mmin … max[90m): [39m0.00% … 0.00%
 Time  [90m([39m[34m[1mmedian[22m[39m[90m):     [39m[34m[1m213.435 ns               [22m[39m[90m┊[39m GC [90m([39mmedian[90m):    [39m0.00%
 Time  [90m([39m[32m[1mmean[22m[39m ± [32mσ[39m[90m):   [39m[32m[1m244.608 ns[22m[39m ± [32m137.134 ns[39m  [90m┊[39m GC [90m([39mmean ± σ[90m):  [39m0.00% ± 0.00%

  [39m▃[39m█[39m▅[34m▇[39m[39m▂[39m▃[39m▂[39m▂[32m▁[39m[39m▁[39m [39m [39m▁[39m▁[39m▂[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m [39m▁[39m [39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m▁
  [39m█[39m█[39m█[34m█[39m[39m█[39m█[39m█[39m█[32m█[39m[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m▇[39m▇[39m▇[39m▆[39m▆[39m▆[39m▆[39m▆[39m▆[39m▆[39m▆[39m▅[39m▅[39m▅[39m▅[39m▄[39m▅[39m▃[39m▄[39m▄[39m▄[39m▄[39m▅[39m [39m█
  195 ns[90m        [39m[90mHistogram: [39m[90m[1mlog([22m[39m[90mfrequency[39m[90m[1m)[22m[39m[90m by time[39m        557 ns [0m[1m&lt;[22m

 Memory estimate[90m: [39m[33m0 bytes[39m, allocs estimate[90m: [39m[33m0[39m.</code></pre>
</div>
</div>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">intersect</span>(tar, ref) setup<span class="op">=</span>(tar <span class="op">=</span> target; ref <span class="op">=</span> rangetree21)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>BenchmarkTools.Trial: 10000 samples with 305 evaluations.
 Range [90m([39m[36m[1mmin[22m[39m … [35mmax[39m[90m):  [39m[36m[1m272.275 ns[22m[39m … [35m71.150 μs[39m  [90m┊[39m GC [90m([39mmin … max[90m): [39m 0.00% … 99.31%
 Time  [90m([39m[34m[1mmedian[22m[39m[90m):     [39m[34m[1m299.725 ns              [22m[39m[90m┊[39m GC [90m([39mmedian[90m):    [39m 0.00%
 Time  [90m([39m[32m[1mmean[22m[39m ± [32mσ[39m[90m):   [39m[32m[1m370.576 ns[22m[39m ± [32m 1.848 μs[39m  [90m┊[39m GC [90m([39mmean ± σ[90m):  [39m14.06% ±  2.81%

  [39m▄[39m▄[39m█[39m▄[39m▇[34m▇[39m[39m▂[39m▁[39m▁[39m▁[39m [39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[32m [39m[39m [39m [39m [39m [39m▁[39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m▂
  [39m█[39m█[39m█[39m█[39m█[34m█[39m[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[32m█[39m[39m█[39m█[39m▇[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m▇[39m▇[39m▇[39m▇[39m▇[39m▇[39m▇[39m▆[39m▆[39m▆[39m▇[39m▆[39m▇[39m▇[39m▅[39m▆[39m▆[39m▆[39m▇[39m▆[39m▆[39m▅[39m▆[39m▆[39m▄[39m▄[39m▅[39m [39m█
  272 ns[90m        [39m[90mHistogram: [39m[90m[1mlog([22m[39m[90mfrequency[39m[90m[1m)[22m[39m[90m by time[39m       616 ns [0m[1m&lt;[22m

 Memory estimate[90m: [39m[33m480 bytes[39m, allocs estimate[90m: [39m[33m3[39m.</code></pre>
</div>
</div>
</section>
<section id="intervaltree" class="level3">
<h3 class="anchored" data-anchor-id="intervaltree">IntervalTree</h3>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">intersect!</span>(res, tar, ref) setup<span class="op">=</span>(res <span class="op">=</span> result; tar <span class="op">=</span> target; ref <span class="op">=</span> intvltree21)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>BenchmarkTools.Trial: 10000 samples with 192 evaluations.
 Range [90m([39m[36m[1mmin[22m[39m … [35mmax[39m[90m):  [39m[36m[1m521.359 ns[22m[39m … [35m 1.491 μs[39m  [90m┊[39m GC [90m([39mmin … max[90m): [39m0.00% … 0.00%
 Time  [90m([39m[34m[1mmedian[22m[39m[90m):     [39m[34m[1m566.016 ns              [22m[39m[90m┊[39m GC [90m([39mmedian[90m):    [39m0.00%
 Time  [90m([39m[32m[1mmean[22m[39m ± [32mσ[39m[90m):   [39m[32m[1m590.870 ns[22m[39m ± [32m88.561 ns[39m  [90m┊[39m GC [90m([39mmean ± σ[90m):  [39m0.00% ± 0.00%

  [39m [39m▅[39m▇[39m▄[39m▇[34m█[39m[39m▇[39m▆[32m▆[39m[39m▃[39m▃[39m▂[39m [39m▁[39m▂[39m▁[39m▁[39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m▂
  [39m█[39m█[39m█[39m█[39m█[34m█[39m[39m█[39m█[32m█[39m[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m█[39m▆[39m▆[39m█[39m▇[39m▇[39m█[39m▇[39m▆[39m▇[39m▆[39m▆[39m█[39m▇[39m▇[39m▇[39m▇[39m▆[39m▇[39m▇[39m▅[39m▆[39m▆[39m▆[39m▅[39m▇[39m▅[39m▆[39m▅[39m▅[39m▃[39m▆[39m▅[39m▆[39m▆[39m▆[39m▆[39m▆[39m▆[39m▆[39m▅[39m▅[39m [39m█
  521 ns[90m        [39m[90mHistogram: [39m[90m[1mlog([22m[39m[90mfrequency[39m[90m[1m)[22m[39m[90m by time[39m      1.02 μs [0m[1m&lt;[22m

 Memory estimate[90m: [39m[33m80 bytes[39m, allocs estimate[90m: [39m[33m3[39m.</code></pre>
</div>
</div>
<ul>
<li>In what follows we will use the <code>RangeTree</code> method for <code>intersect!</code> to obtain the intersections.</li>
</ul>
</section>
</section>
<section id="determining-coverage" class="level2">
<h2 class="anchored" data-anchor-id="determining-coverage">Determining coverage</h2>
<ul>
<li><p>The <code>coverage</code> of a target by a set of reference intervals is the proportion of the base pairs in the target that intersect with one or more of the reference intervals.</p></li>
<li><p>We need to somehow count the number of elements in the union of the intervals returned from <code>intersect!</code>.</p></li>
<li><p>This could be done using the <code>union!</code> method for a <a href="https://docs.julialang.org/en/v1/base/collections/#Base.BitSet">BitSet</a> but that approach has two problems: it is comparatively slow and, in Julia versions up to 1.8.0-rc1, it can be wrong.</p></li>
</ul>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>While creating these notes we discovered a <a href="https://github.com/JuliaLang/julia/pull/45574">bug</a> in the <code>union!</code> method for a <code>BitSet</code> and a <code>UnitRange</code>.</li>
<li>There was a <a href="https://github.com/JuliaLang/julia/pull/45578">PR</a> to fix it the next morning.</li>
<li>Versions of Julia prior to 1.8.0-rc2 can (and probably will) return incorrect values of coverage.</li>
<li>Replacing <code>union!(bs, isect)</code> by <code>union!(bs, BitSet(isect))</code> avoids this “infelicity” at the expense of more memory usage and compute time.</li>
</ul>
</div>
</div>
<ul>
<li><p>There is a better method that takes advantage of the intersecting intervals being produced in sorted order by <code>first</code></p></li>
<li><p>The idea is to “keep moving the goalposts”. When evaluating the coverage count, add the length of the current reference interval’s intersection with only the part to the right of what has already been covered.</p></li>
</ul>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">coveragecount</span>(</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  target<span class="op">::</span><span class="dt">AbstractUnitRange</span>,</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  isects<span class="op">::</span><span class="dt">Vector{UnitRange{T}}</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>) <span class="kw">where</span> {T}</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  goalposts <span class="op">=</span> target</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  rightpost <span class="op">=</span> <span class="fu">last</span>(goalposts)</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  coverage <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> isect <span class="kw">in</span> isects</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    coverage <span class="op">+=</span> <span class="fu">length</span>(<span class="fu">intersect</span>(goalposts, isect))</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    goalposts <span class="op">=</span> (<span class="fu">last</span>(isect) <span class="op">+</span> <span class="fu">one</span>(T))<span class="op">:</span>rightpost</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> coverage</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a><span class="fu">coveragecount</span>(target, cachedresult)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>2411</code></pre>
</div>
</div>
</section>
<section id="iterating-over-a-set-of-targets" class="level2">
<h2 class="anchored" data-anchor-id="iterating-over-a-set-of-targets">Iterating over a set of targets</h2>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">overlaps</span>(targets<span class="op">::</span><span class="dt">Vector{UnitRange{T}}</span>, refs<span class="op">::</span><span class="dt">RangeTree{T}</span>) <span class="kw">where</span> {T}</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  ntargets <span class="op">=</span> <span class="fu">length</span>(targets)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  nover <span class="op">=</span> <span class="fu">sizehint!</span>(<span class="dt">Int</span>[], ntargets)</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  covcount <span class="op">=</span> <span class="fu">sizehint!</span>(T[], ntargets)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  result <span class="op">=</span> <span class="dt">UnitRange</span>{T}[]</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> tar <span class="kw">in</span> targets</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">push!</span>(nover, <span class="fu">length</span>(<span class="fu">intersect!</span>(result, tar, refs)))</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">push!</span>(covcount, <span class="fu">coveragecount</span>(tar, result))</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">DataFrame</span>(targets <span class="op">=</span> targets, nover <span class="op">=</span> nover, covcount <span class="op">=</span> covcount)</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="fu">overlaps</span>(rnarange21, rangetree21)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<div class="data-frame"><p>71,347 rows × 3 columns</p><table class="data-frame table table-sm table-striped"><thead><tr><th></th><th>targets</th><th>nover</th><th>covcount</th></tr><tr><th></th><th title="UnitRange{Int32}">UnitRang…</th><th title="Int64">Int64</th><th title="Int32">Int32</th></tr></thead><tbody><tr><th>1</th><td>8212585:8212728</td><td>1</td><td>140</td></tr><tr><th>2</th><td>8207701:8252389</td><td>11</td><td>3374</td></tr><tr><th>3</th><td>8256795:8256941</td><td>1</td><td>139</td></tr><tr><th>4</th><td>46189146:46189503</td><td>3</td><td>358</td></tr><tr><th>5</th><td>46188448:46188611</td><td>5</td><td>164</td></tr><tr><th>6</th><td>14371115:14371404</td><td>1</td><td>290</td></tr><tr><th>7</th><td>8439844:8439977</td><td>1</td><td>132</td></tr><tr><th>8</th><td>5116341:5118826</td><td>4</td><td>1027</td></tr><tr><th>9</th><td>41427205:41447715</td><td>29</td><td>5190</td></tr><tr><th>10</th><td>39342315:39342766</td><td>3</td><td>452</td></tr><tr><th>11</th><td>8256801:8256946</td><td>1</td><td>133</td></tr><tr><th>12</th><td>34710834:34711564</td><td>0</td><td>0</td></tr><tr><th>13</th><td>42381884:42390040</td><td>14</td><td>2632</td></tr><tr><th>14</th><td>8256806:8256945</td><td>1</td><td>128</td></tr><tr><th>15</th><td>32734855:32735209</td><td>4</td><td>213</td></tr><tr><th>16</th><td>18857745:18858482</td><td>1</td><td>498</td></tr><tr><th>17</th><td>41440888:41459212</td><td>20</td><td>3769</td></tr><tr><th>18</th><td>33567155:33577493</td><td>33</td><td>4703</td></tr><tr><th>19</th><td>14485242:14487444</td><td>2</td><td>873</td></tr><tr><th>20</th><td>8212141:8212352</td><td>0</td><td>0</td></tr><tr><th>21</th><td>44805624:44806001</td><td>1</td><td>378</td></tr><tr><th>22</th><td>6641565:6642449</td><td>0</td><td>0</td></tr><tr><th>23</th><td>8439843:8439983</td><td>1</td><td>133</td></tr><tr><th>24</th><td>33903507:33903641</td><td>4</td><td>135</td></tr><tr><th>25</th><td>33903459:33914500</td><td>20</td><td>2079</td></tr><tr><th>26</th><td>8253486:8253820</td><td>0</td><td>0</td></tr><tr><th>27</th><td>41446033:41459183</td><td>9</td><td>1979</td></tr><tr><th>28</th><td>8395617:8395768</td><td>1</td><td>143</td></tr><tr><th>29</th><td>25562141:25574230</td><td>4</td><td>540</td></tr><tr><th>30</th><td>25880810:25881623</td><td>6</td><td>814</td></tr><tr><th>⋮</th><td>⋮</td><td>⋮</td><td>⋮</td></tr></tbody></table></div>
</div>
</div>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">overlaps</span>(targets, refs) setup<span class="op">=</span>(targets <span class="op">=</span> rnarange21; refs <span class="op">=</span> rangetree21)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>BenchmarkTools.Trial: 212 samples with 1 evaluation.
 Range [90m([39m[36m[1mmin[22m[39m … [35mmax[39m[90m):  [39m[36m[1m21.441 ms[22m[39m … [35m38.306 ms[39m  [90m┊[39m GC [90m([39mmin … max[90m): [39m0.00% … 39.21%
 Time  [90m([39m[34m[1mmedian[22m[39m[90m):     [39m[34m[1m22.975 ms              [22m[39m[90m┊[39m GC [90m([39mmedian[90m):    [39m0.00%
 Time  [90m([39m[32m[1mmean[22m[39m ± [32mσ[39m[90m):   [39m[32m[1m23.583 ms[22m[39m ± [32m 1.976 ms[39m  [90m┊[39m GC [90m([39mmean ± σ[90m):  [39m0.59% ±  3.79%

  [39m [39m [39m [39m [39m▁[39m█[39m▅[39m█[39m▄[39m▃[39m▆[34m▅[39m[39m [39m [39m [39m [32m [39m[39m▂[39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m 
  [39m▃[39m▃[39m▆[39m▆[39m█[39m█[39m█[39m█[39m█[39m█[39m█[34m█[39m[39m█[39m▇[39m▄[39m▅[32m▅[39m[39m█[39m▄[39m▄[39m▄[39m▆[39m▆[39m▅[39m▅[39m█[39m▄[39m▄[39m▃[39m▄[39m▃[39m▃[39m▃[39m▄[39m▃[39m▅[39m▃[39m▁[39m▁[39m▃[39m▃[39m▃[39m▁[39m▁[39m▁[39m▃[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▃[39m▁[39m▁[39m▁[39m▃[39m [39m▄
  21.4 ms[90m         Histogram: frequency by time[39m        29.6 ms [0m[1m&lt;[22m

 Memory estimate[90m: [39m[33m2.18 MiB[39m, allocs estimate[90m: [39m[33m41[39m.</code></pre>
</div>
</div>
</section>
<section id="the-whole-shootin-match" class="level2">
<h2 class="anchored" data-anchor-id="the-whole-shootin-match">The whole shootin’ match</h2>
<ul>
<li>The computations on different chromosome are independent of each other and can be assigned to different threads when Julia is started with multiple threads.</li>
</ul>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">overlaps</span>(</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  targets<span class="op">::</span><span class="dt">Dict{Symbol, Vector{UnitRange{T}}}</span>,</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  refdict<span class="op">::</span><span class="dt">Dict{Symbol, RangeTree{T}}</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>) <span class="kw">where</span> {T}</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  value <span class="op">=</span> <span class="fu">Dict</span><span class="dt">{Symbol, DataFrame}</span>()</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>  <span class="pp">@sync</span> <span class="cf">for</span> k <span class="kw">in</span> <span class="fu">intersect</span>(<span class="fu">keys</span>(targets), <span class="fu">keys</span>(refdict))</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Threads</span>.<span class="pp">@spawn</span> value[k] <span class="op">=</span> <span class="fu">overlaps</span>(targets[k], refdict[k])</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> value</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>bigresult <span class="op">=</span> <span class="fu">overlaps</span>(rnarangevecs, annorangetrees);</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>bigresult[<span class="op">:</span>chrY]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<div class="data-frame"><p>89 rows × 3 columns</p><table class="data-frame table table-sm table-striped"><thead><tr><th></th><th>targets</th><th>nover</th><th>covcount</th></tr><tr><th></th><th title="UnitRange{Int32}">UnitRang…</th><th title="Int64">Int64</th><th title="Int32">Int32</th></tr></thead><tbody><tr><th>1</th><td>13286599:13287476</td><td>1</td><td>741</td></tr><tr><th>2</th><td>13286598:13287541</td><td>1</td><td>741</td></tr><tr><th>3</th><td>13286599:13287542</td><td>1</td><td>741</td></tr><tr><th>4</th><td>13286648:13287509</td><td>1</td><td>731</td></tr><tr><th>5</th><td>13286679:13287469</td><td>1</td><td>700</td></tr><tr><th>6</th><td>5793260:5793463</td><td>1</td><td>164</td></tr><tr><th>7</th><td>5793274:5793472</td><td>1</td><td>173</td></tr><tr><th>8</th><td>10200166:10200308</td><td>1</td><td>141</td></tr><tr><th>9</th><td>13287196:13287541</td><td>1</td><td>183</td></tr><tr><th>10</th><td>18992142:18992375</td><td>0</td><td>0</td></tr><tr><th>11</th><td>18992104:18992424</td><td>0</td><td>0</td></tr><tr><th>12</th><td>24362036:24362135</td><td>0</td><td>0</td></tr><tr><th>13</th><td>13287300:13287543</td><td>1</td><td>79</td></tr><tr><th>14</th><td>18992170:18992298</td><td>0</td><td>0</td></tr><tr><th>15</th><td>13286570:13287469</td><td>1</td><td>741</td></tr><tr><th>16</th><td>13286566:13287413</td><td>1</td><td>741</td></tr><tr><th>17</th><td>13287043:13287440</td><td>1</td><td>336</td></tr><tr><th>18</th><td>11336248:11442584</td><td>15</td><td>4284</td></tr><tr><th>19</th><td>13286619:13287467</td><td>1</td><td>741</td></tr><tr><th>20</th><td>13286571:13287542</td><td>1</td><td>741</td></tr><tr><th>21</th><td>13286659:13287547</td><td>1</td><td>720</td></tr><tr><th>22</th><td>13286587:13287543</td><td>1</td><td>741</td></tr><tr><th>23</th><td>5793255:5793467</td><td>1</td><td>168</td></tr><tr><th>24</th><td>13287260:13287542</td><td>1</td><td>119</td></tr><tr><th>25</th><td>13286762:13287408</td><td>1</td><td>617</td></tr><tr><th>26</th><td>13286725:13287522</td><td>1</td><td>654</td></tr><tr><th>27</th><td>5337673:5338106</td><td>1</td><td>362</td></tr><tr><th>28</th><td>13286617:13287543</td><td>1</td><td>741</td></tr><tr><th>29</th><td>18992107:18992666</td><td>1</td><td>200</td></tr><tr><th>30</th><td>13286699:13287435</td><td>1</td><td>680</td></tr><tr><th>⋮</th><td>⋮</td><td>⋮</td><td>⋮</td></tr></tbody></table></div>
</div>
</div>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">overlaps</span>(targets, refs) setup<span class="op">=</span>(targets <span class="op">=</span> rnarangevecs; refs <span class="op">=</span> annorangetrees)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>BenchmarkTools.Trial: 7 samples with 1 evaluation.
 Range [90m([39m[36m[1mmin[22m[39m … [35mmax[39m[90m):  [39m[36m[1m657.804 ms[22m[39m … [35m   1.112 s[39m  [90m┊[39m GC [90m([39mmin … max[90m): [39m0.00% … 6.05%
 Time  [90m([39m[34m[1mmedian[22m[39m[90m):     [39m[34m[1m694.623 ms               [22m[39m[90m┊[39m GC [90m([39mmedian[90m):    [39m0.00%
 Time  [90m([39m[32m[1mmean[22m[39m ± [32mσ[39m[90m):   [39m[32m[1m743.589 ms[22m[39m ± [32m163.565 ms[39m  [90m┊[39m GC [90m([39mmean ± σ[90m):  [39m1.29% ± 2.28%

  [39m▃[39m [39m [39m [34m█[39m[39m [39m [39m [39m [39m [39m [39m [32m [39m[39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m [39m 
  [39m█[39m▁[39m▁[39m▁[34m█[39m[39m▇[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[32m▁[39m[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▁[39m▇[39m [39m▁
  658 ms[90m           Histogram: frequency by time[39m          1.11 s [0m[1m&lt;[22m

 Memory estimate[90m: [39m[33m149.71 MiB[39m, allocs estimate[90m: [39m[33m741[39m.</code></pre>
</div>
</div>
</section>
<section id="conclusions" class="level2">
<h2 class="anchored" data-anchor-id="conclusions">Conclusions</h2>
<ul>
<li>The ability to work in the REPL (or VS Code or Jupyter notebooks) encourages iterative refinement of algorithms.</li>
<li>“Trust but verify” - when making a change or introducing new methods it helps to have results from previous methods for comparison. In general, continuous integration (CI) testing is straightforward for Julia packages and is strongly encouraged.</li>
<li>There are many tools for benchmarking function execution or storage allocation, allowing a developer to concentrate on where the “real problem” is.</li>
<li>In certain cases, enhancements like multi-threading can be achieved with very little effort.</li>
</ul>
</section>
<section id="version-information" class="level2">
<h2 class="anchored" data-anchor-id="version-information">Version information</h2>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">versioninfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Julia Version 1.8.0-rc1
Commit 6368fdc6565 (2022-05-27 18:33 UTC)
Platform Info:
  OS: macOS (x86_64-apple-darwin21.4.0)
  CPU: 8 × Intel(R) Core(TM) i7-8569U CPU @ 2.80GHz
  WORD_SIZE: 64
  LIBM: libopenlibm
  LLVM: libLLVM-13.0.1 (ORCJIT, skylake)
  Threads: 4 on 8 virtual cores</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>