<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-99.9.9">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Douglas Bates and Claudia Solis-Lemus">
<meta name="dcterms.date" content="2022-06-27">

<title>Julia Workshop - Session 2b: Determining Interval Overlap</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./session4-exercise.html" rel="next">
<link href="./session2a-tables-and-arrow.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Julia Workshop</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page">Home</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html">About</a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/crsl4/julia-workshop"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Session 2b: Determining Interval Overlap</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Julia Workshop for Data Science</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./session1-get-started.html" class="sidebar-item-text sidebar-link">Session 1: Getting started with Julia</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./session2a-tables-and-arrow.html" class="sidebar-item-text sidebar-link">Session 2a: Data Tables and Arrow files</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./session2b-interval-overlap.html" class="sidebar-item-text sidebar-link active">Session 2b: Determining Interval Overlap</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./session4-exercise.html" class="sidebar-item-text sidebar-link">Session 4: Hands-on exercise</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./session5-other-tools.html" class="sidebar-item-text sidebar-link">Session 5: Other tools for Data Science</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./session6-conclusions.html" class="sidebar-item-text sidebar-link">Session 6: Conclusions</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#load-packages-to-be-used" id="toc-load-packages-to-be-used" class="nav-link active" data-scroll-target="#load-packages-to-be-used">Load packages to be used</a></li>
  <li><a href="#strategy-for-computing-overlaps" id="toc-strategy-for-computing-overlaps" class="nav-link" data-scroll-target="#strategy-for-computing-overlaps">Strategy for computing overlaps</a>
  <ul class="collapse">
  <li><a href="#creating-dictionaries-of-vectorunitrange" id="toc-creating-dictionaries-of-vectorunitrange" class="nav-link" data-scroll-target="#creating-dictionaries-of-vectorunitrange">Creating dictionaries of Vector{UnitRange}</a></li>
  </ul></li>
  <li><a href="#intersecting-reference-ranges-with-a-target" id="toc-intersecting-reference-ranges-with-a-target" class="nav-link" data-scroll-target="#intersecting-reference-ranges-with-a-target">Intersecting reference ranges with a target</a></li>
  <li><a href="#dictionaries-of-rangetrees-and-intervaltrees" id="toc-dictionaries-of-rangetrees-and-intervaltrees" class="nav-link" data-scroll-target="#dictionaries-of-rangetrees-and-intervaltrees">Dictionaries of RangeTrees and IntervalTrees</a>
  <ul class="collapse">
  <li><a href="#rangetrees" id="toc-rangetrees" class="nav-link" data-scroll-target="#rangetrees">RangeTrees</a></li>
  <li><a href="#intervaltrees" id="toc-intervaltrees" class="nav-link" data-scroll-target="#intervaltrees">IntervalTrees</a></li>
  </ul></li>
  <li><a href="#time-for-a-shootout" id="toc-time-for-a-shootout" class="nav-link" data-scroll-target="#time-for-a-shootout">Time for a shootout</a>
  <ul class="collapse">
  <li><a href="#vectorunitrange" id="toc-vectorunitrange" class="nav-link" data-scroll-target="#vectorunitrange">Vector{UnitRange}</a></li>
  <li><a href="#rangetree" id="toc-rangetree" class="nav-link" data-scroll-target="#rangetree">RangeTree</a></li>
  <li><a href="#intervaltree" id="toc-intervaltree" class="nav-link" data-scroll-target="#intervaltree">IntervalTree</a></li>
  </ul></li>
  <li><a href="#determining-coverage" id="toc-determining-coverage" class="nav-link" data-scroll-target="#determining-coverage">Determining coverage</a></li>
  <li><a href="#iterating-over-a-collection-of-targets" id="toc-iterating-over-a-collection-of-targets" class="nav-link" data-scroll-target="#iterating-over-a-collection-of-targets">Iterating over a collection of targets</a></li>
  <li><a href="#the-whole-shootin-match" id="toc-the-whole-shootin-match" class="nav-link" data-scroll-target="#the-whole-shootin-match">The whole shootin’ match</a></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions">Conclusions</a></li>
  <li><a href="#version-information" id="toc-version-information" class="nav-link" data-scroll-target="#version-information">Version information</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/crsl4/julia-workshop/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Session 2b: Determining Interval Overlap</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Douglas Bates and Claudia Solis-Lemus </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2022-06-27</p>
    </div>
  </div>
    
  </div>
  

</header>

<section id="load-packages-to-be-used" class="level2">
<h2 class="anchored" data-anchor-id="load-packages-to-be-used">Load packages to be used</h2>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Arrow          </span><span class="co"># Arrow storage and file format</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">BenchmarkTools </span><span class="co"># tools for benchmarking code</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">DataFrames     </span><span class="co"># versatile tabular data format</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">IntervalTrees  </span><span class="co"># interval trees from BioJulia</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">RangeTrees     </span><span class="co"># a bespoke implementation of interval trees</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Tables         </span><span class="co"># row- or column-oriented tabular data</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Base</span>: intersect! <span class="co"># not exported from Base</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>datadir <span class="op">=</span> <span class="fu">joinpath</span>(<span class="pp">@__DIR__</span>, <span class="st">"biofast-data-v1"</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</section>
<section id="strategy-for-computing-overlaps" class="level1">
<h1>Strategy for computing overlaps</h1>
<ul>
<li><p>Split the data in the Arrow data tables into a dictionary where the keys are the chromosome tag and values are the <code>start-stop</code> pairs expressed as a <code>Vector{UnitRange}</code>. For the reference ranges, sort the vectors by increasing <code>first</code> value.</p></li>
<li><p>For the reference ranges create two other dictionaries with values from <a href="https://github.com/dmbates/RangeTrees.jl">RangeTrees.jl</a> and from <a href="https://github.com/BioJulia/IntervalTrees.jl">IntervalTrees.jl</a>, respectively.</p></li>
<li><p>Benchmark the intersection with a target <code>UnitRange</code> from each of the representations of the reference ranges. Do this in two ways: <code>intersect</code>, which allocates the storage for the result, and <code>intersect!</code>, which modifies one of its arguments with the result.</p></li>
<li><p>Compute the coverage from the vector of intersections.</p></li>
<li><p>Apply the methods to the complete set of targets.</p></li>
</ul>
<section id="creating-dictionaries-of-vectorunitrange" class="level2">
<h2 class="anchored" data-anchor-id="creating-dictionaries-of-vectorunitrange">Creating dictionaries of Vector{UnitRange}</h2>
<ul>
<li>A <code>UnitRange</code>, such as <code>2:10</code>, includes the end points, accessed by <code>first</code> and <code>last</code> methods.</li>
</ul>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(<span class="fl">2</span><span class="op">:</span><span class="fl">10</span>), <span class="fu">length</span>(<span class="fl">2</span><span class="op">:</span><span class="fl">10</span>), <span class="fu">first</span>(<span class="fl">2</span><span class="op">:</span><span class="fl">10</span>), <span class="fu">last</span>(<span class="fl">2</span><span class="op">:</span><span class="fl">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>(UnitRange{Int64}, 9, 2, 10)</code></pre>
</div>
</div>
<ul>
<li><p>However, the positions in the <code>start</code> and <code>stop</code> columns in a <code>.bed</code> file are not both included in the range they represent. The positions correspond to base pairs in the range <code>start:(stop - 1)</code> as 0-based indices on the chromosome or <code>(start + 1):stop</code> as 1-based indices.</p></li>
<li><p>It doesn’t matter which one we use as long as we are consistent in creating ranges from the reference intervals and the target intervals.</p></li>
<li><p>We choose to start counting from 1, just as the <a href="https://twitter.com/CountVonCount">world’s foremost expert on counting</a> does.</p></li>
<li><p>We wrap this conversion in a utility function to help ensure consistency.</p></li>
</ul>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">asrange</span>(start, stop) <span class="op">=</span> (start <span class="op">+</span> <span class="fu">one</span>(start))<span class="op">:</span>stop</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>asrange (generic function with 1 method)</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
“One-liner” function (actually method) definitions
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This method definition uses the compact “one-liner” form, like the math notation <code>f(x) = x + 1</code>.</p>
</div>
</div>
</div>
<div class="callout-note callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
<code>one(x)</code> versus literal <code>1</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><code>one(x)</code> is used instead of the literal <code>1</code> in <code>asrange</code> to preserve the integer type (see also <code>?oneunit</code>, which is slighly more general).</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>st <span class="op">=</span> <span class="fu">Int32</span>(<span class="fl">2314</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(st <span class="op">+</span> <span class="fl">1</span>)       <span class="co"># type gets promoted to Int64</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>Int64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(st <span class="op">+</span> <span class="fu">one</span>(st)) <span class="co"># type not promoted</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>Int32</code></pre>
</div>
</div>
</div>
</div>
</div>
<ul>
<li><p>Create a utility, <code>chromodict</code> to read an <code>Arrow.Table</code> and convert it to a <code>Dict{Symbol, Vector{UnitRange{T}}}</code>, assuming that the table contains columns named <code>:chromo</code>, <code>:start</code>, and <code>:stop</code>.</p></li>
<li><p>We define two methods, one that takes a “row-table”, which is a vector of named tuples, and one that takes the file name of the arrow file, reads the (column oriented)table, converts it to a row table, and then calls the first method.</p></li>
</ul>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">chromodict</span>(rtbl<span class="op">::</span><span class="dt">Vector{&lt;:NamedTuple}</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  itype <span class="op">=</span> <span class="fu">promote_type</span>(</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    Tables.<span class="fu">columntype</span>(rtbl, <span class="op">:</span>start),</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    Tables.<span class="fu">columntype</span>(rtbl, <span class="op">:</span>stop),</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  vtype <span class="op">=</span> <span class="dt">Vector</span>{<span class="dt">UnitRange</span>{itype}}</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  dict <span class="op">=</span> <span class="fu">Dict</span><span class="dt">{Symbol,vtype}</span>()</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (; chromo, start, stop) <span class="kw">in</span> rtbl</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">push!</span>(</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">get!</span>(dict, <span class="fu">Symbol</span>(chromo), <span class="fu">vtype</span>()),</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">asrange</span>(start, stop),</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> dict</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">chromodict</span>(fnm<span class="op">::</span><span class="dt">AbstractString</span>)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">chromodict</span>(<span class="fu">rowtable</span>(Arrow.<span class="fu">Table</span>(<span class="fu">joinpath</span>(datadir, fnm))))</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>tarrngvecs <span class="op">=</span> <span class="fu">chromodict</span>(<span class="st">"ex-rna.arrow"</span>)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>refrngvecs <span class="op">=</span> <span class="fu">chromodict</span>(<span class="st">"ex-anno.arrow"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>Dict{Symbol, Vector{UnitRange{Int32}}} with 24 entries:
  :chr21 =&gt; [5011799:5011874, 5012548:5012687, 5014386:5014471, 5016935:5017145…
  :chr15 =&gt; [19878555:19878668, 19878831:19879004, 19881201:19881307, 19882277:…
  :chr10 =&gt; [14497:14604, 14061:14299, 16502:16544, 14138:14299, 44712:44901, 4…
  :chr17 =&gt; [76723:76866, 75814:75878, 71366:71556, 65830:65887, 64099:65736, 1…
  :chr07 =&gt; [12704:12822, 26965:27199, 24314:24365, 26965:27234, 31060:31194, 2…
  :chr14 =&gt; [16057472:16057622, 18333726:18333900, 18337973:18338078, 18338243:…
  :chr08 =&gt; [64269:64320, 64091:64175, 72601:72673, 78905:79775, 72617:72701, 7…
  :chr12 =&gt; [12310:12358, 12740:12824, 13102:13201, 13370:13501, 31878:32015, 2…
  :chr18 =&gt; [11103:11595, 15617:15822, 11191:11595, 13152:13354, 15617:15928, 1…
  :chrX  =&gt; [253743:253846, 254937:255091, 276322:276394, 281482:281684, 284167…
  :chr13 =&gt; [18177555:18178465, 18176018:18176170, 18174442:18174512, 18174010:…
  :chr11 =&gt; [75780:76143, 86649:87586, 125578:125927, 121258:121426, 113116:113…
  :chr22 =&gt; [10736171:10736283, 10961283:10961338, 10959067:10959136, 10950049:…
  :chr03 =&gt; [23757:23812, 23968:24501, 54293:54346, 53348:53692, 196607:196859,…
  :chr19 =&gt; [70928:70976, 66346:66499, 60951:61894, 62113:66524, 70928:70951, 6…
  :chr05 =&gt; [58198:58915, 92151:92276, 113251:113448, 139483:140716, 143047:143…
  :chr06 =&gt; [95124:95454, 105919:106856, 144536:144885, 140211:140379, 131910:1…
  :chr20 =&gt; [87250:87359, 96005:97094, 87710:87767, 96005:96533, 142369:142686,…
  :chrY  =&gt; [2784749:2784853, 2786855:2787699, 2789827:2790328, 2827982:2828218…
  :chr04 =&gt; [49096:49956, 49554:50124, 53285:53491, 59430:59556, 60058:60153, 8…
  :chr02 =&gt; [45440:46385, 38814:41627, 42809:42952, 41220:41627, 46807:46870, 4…
  :chr01 =&gt; [11869:12227, 12613:12721, 13221:14409, 12010:12057, 12179:12227, 1…
  :chr09 =&gt; [12134:12190, 12291:12340, 12726:12834, 13088:13157, 13338:13487, 1…
  :chr16 =&gt; [11555:11908, 12294:12402, 12902:14090, 11861:11908, 12294:12378, 1…</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Mutating <code>get!</code> for a <code>Dict</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The call <code>get!(dict, Symbol(chromo), vtype())</code> in <code>chromodict</code> returns <code>dict[Symbol(chromo)]</code> or the default value, which is an empty <code>Vector{UnitRange{T}}</code>. For the case of the default, it also installs that key/value pair in <code>dict</code>.</p>
</div>
</div>
</div>
<div class="callout-note callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
<code>Symbol</code>s versus <code>String</code>s for <code>Dict</code> keys
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>We use <code>Symbol</code>s for the keys in these <code>Dict</code>s because they are easier to type and because symbol table lookup is very fast, although that doesn’t really matter when we only have 24 distinct keys.</p>
</div>
</div>
</div>
<div class="callout-note callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Destructuring a struct or NamedTuple
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The expression <code>for (; chromo, start, stop) in rtbl</code> is equivalent to three local assignments</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> r <span class="kw">in</span> rtbl</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  chromo <span class="op">=</span> r.chromo</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  start <span class="op">=</span> r.start</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  stop <span class="op">=</span> r.stop</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In other words, it is equivalent to taking the named fields of a <code>NamedTuple</code> or a <code>struct</code> and making them available in the local namespace under the same names.</p>
</div>
</div>
</div>
<div class="callout-note callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Interfaces to row- and column-oriented tables in <code>Tables.jl</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><a href="https://github.com/JuliaData/Tables.jl">Tables.jl</a> provides interfaces for row- and column-oriented tables, allowing for one orientation to be viewed as the other. In this case an <code>Arrow.Table</code> is column-oriented but <code>rowtable</code> of this table returns a <code>Vector{NamedTuple{(:chromo, :start, :stop), Tuple{String, Int32, Int32}}}</code> to iterate over the rows. When a “method instance” of <code>chromodict</code> is compiled for such a table, the schema of the rows will be known.</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@code_warntype</span> <span class="fu">chromodict</span>(<span class="fu">rowtable</span>(Arrow.<span class="fu">Table</span>(<span class="st">"biofast-data-v1/ex-anno.arrow"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MethodInstance for chromodict(::</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Vector{NamedTuple{(:chromo, :start, :stop), Tuple{String, Int32, Int32}}})
  from chromodict(rtbl::Vector{&lt;:NamedTuple}) in Main at In[7]:1
Arguments
  #self#::Core.Const(chromodict)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
  rtbl::Vector{NamedTuple{(:chromo, :start, :stop), Tuple{String, Int32, Int32}}}
Locals
  @_3::Union{Nothing, Tuple{NamedTuple{(:chromo, :start, :stop), Tuple{String, Int32, Int32}}, Int64}}
  dict::Dict{Symbol, Vector{UnitRange{Int32}}}
  vtype::Type{Vector{UnitRange{Int32}}}
  itype::Type{Int32}
  stop::Int32
  start::Int32
  chromo::String
Body::Dict{Symbol, Vector{UnitRange{Int32}}}</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>1 ─ %1  = Tables.columntype</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>::Core.Const(Tables.columntype)
│   %2  = (</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>%1)(rtbl, :start)::Core.Const(Int32)
│   %3  = Tables.columntype::Core.Const(Tables.columntype)
│   %4  = (%3)(rtbl, :stop)::Core.Const(Int32)
│         (itype = Main.promote_type(%2, %4))
│   %6  = Core.apply_type(Main.UnitRange, itype</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>::Core.Const(Int32))::Core.Const(UnitRange{Int32})
│         (vtype = Core.apply_type(Main.Vector, %6))
│   %8  = Core.apply_type(Main.Dict, Main.Symbol, vtype::Core.Const(Vector{UnitRange{Int32}}))::Core.Const(Dict{Symbol, Vector{UnitRange{Int32}}})
│         (dict = (%8)())
│   %10 = rtbl::Vector{NamedTuple{(:chromo, :start, :stop), Tuple{String, Int32, Int32}}}
│         (@_3 = Base.iterate(%10))
│   %12 = (@_3 === nothing)::Bool
│   %13 = Base.not_int(%12)::Bool
└──       goto #4 if not %13
2 ┄ %15 = @_3::Tuple{NamedTuple{(:chromo, :start, :stop), Tuple{String, Int32, Int32}}, Int64}
│   %16 = Core.getfield(%15, 1)::NamedTuple{(:chromo, :start, :stop), Tuple{String, Int32, Int32}}
│         (chromo = Base.getproperty(%16, :chromo))
│         (start = Base.getproperty(%16, :start))
│         (stop = Base.getproperty(%16, :stop))
│   %20 = Core.getfield(%15, 2)::Int64
│   %21 = dict::Dict{Symbol, Vector{UnitRange{Int32}}}
│   %22 = Main.Symbol(chromo)::Symbol
│   %23 = (vtype::Core.Const(Vector{UnitRange{Int32}}))()::Vector{UnitRange{Int32}}
│   %24 = Main.get!(%21, %22, %23)::Vector{UnitRange{Int32}}
│   %25 = Main.asrange(start, stop)::UnitRange{Int32}
│         Main.push!(%24, %25)
│         (@_3 = Base.iterate(%10, %20))
│   %28 = (@_3 === nothing)::Bool
│   %29 = Base.not_int(%28)::Bool
└──       goto #4 if not %29
3 ─       goto #2
4 ┄       return dict
</code></pre>
</div>
</div>
</div>
</div>
</div>
<ul>
<li><p>In <code>refrngvecs</code>, each of the values, a <code>Vector{UnitRange}</code>, should be sorted by the <code>first</code> element of the <code>UnitRange</code>.</p></li>
<li><p>Creating an <code>IntervalTree</code> requires the ranges to be sorted by <code>first</code> element <strong>and</strong> by <code>last</code> element when the <code>first</code> elements are equal.</p></li>
<li><p>Define a custom <code>lt</code> comparison for this.</p></li>
</ul>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">lt</span>(x<span class="op">::</span><span class="dt">UnitRange{T}</span>, y<span class="op">::</span><span class="dt">UnitRange{T}</span>) <span class="kw">where</span> {T}</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    fx, fy <span class="op">=</span> <span class="fu">first</span>(x), <span class="fu">first</span>(y)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fx <span class="op">==</span> fy ? <span class="fu">last</span>(x) <span class="op">&lt;</span> <span class="fu">last</span>(y) <span class="op">:</span> fx <span class="op">&lt;</span> fy</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> v <span class="kw">in</span> <span class="fu">values</span>(refrngvecs)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sort!</span>(v; lt)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>refrngvecs  <span class="co"># note changes in refrngvecs[:chr01]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>Dict{Symbol, Vector{UnitRange{Int32}}} with 24 entries:
  :chr21 =&gt; [5011799:5011874, 5012548:5012687, 5014386:5014471, 5016935:5017145…
  :chr15 =&gt; [19878555:19878668, 19878831:19879004, 19881201:19881307, 19882277:…
  :chr10 =&gt; [14061:14299, 14138:14299, 14497:14604, 16502:16544, 44712:44901, 4…
  :chr17 =&gt; [64099:65736, 65830:65887, 71366:71556, 75814:75878, 76723:76866, 8…
  :chr07 =&gt; [12704:12822, 19018:19172, 19619:19895, 20834:21029, 24314:24365, 2…
  :chr14 =&gt; [16057472:16057622, 18333726:18333900, 18333826:18333896, 18337973:…
  :chr08 =&gt; [64091:64175, 64269:64320, 72601:72673, 72617:72701, 78905:79244, 7…
  :chr12 =&gt; [12310:12358, 12740:12824, 13102:13201, 13370:13501, 14522:14944, 1…
  :chr18 =&gt; [11103:11595, 11191:11595, 13152:13354, 14195:14653, 14490:14653, 1…
  :chrX  =&gt; [253743:253846, 254937:255091, 276322:276394, 276324:276394, 276353…
  :chr13 =&gt; [18174010:18174103, 18174442:18174512, 18176018:18176170, 18177555:…
  :chr11 =&gt; [75780:76143, 86649:87586, 112967:113111, 113116:113174, 121258:121…
  :chr22 =&gt; [10736171:10736283, 10939388:10939423, 10940597:10940707, 10941691:…
  :chr03 =&gt; [23757:23812, 23968:24501, 53348:53692, 54293:54346, 195758:195914,…
  :chr19 =&gt; [60951:61894, 62113:66524, 63821:64213, 65051:65226, 65822:66047, 6…
  :chr05 =&gt; [58198:58915, 92151:92276, 113251:113448, 139483:140716, 140258:140…
  :chr06 =&gt; [95124:95454, 105919:106856, 131910:132117, 140211:140379, 142272:1…
  :chr20 =&gt; [87250:87359, 87710:87767, 96005:96533, 96005:97094, 142369:142686,…
  :chrY  =&gt; [2784749:2784853, 2786855:2787699, 2789827:2790328, 2827982:2828218…
  :chr04 =&gt; [49096:49956, 49554:50124, 53285:53491, 53286:53491, 53295:53491, 5…
  :chr02 =&gt; [38814:41627, 41220:41627, 41221:41627, 42809:42952, 45440:46385, 4…
  :chr01 =&gt; [11869:12227, 12010:12057, 12179:12227, 12613:12697, 12613:12721, 1…
  :chr09 =&gt; [12134:12190, 12291:12340, 12726:12834, 13088:13157, 13338:13487, 1…
  :chr16 =&gt; [11555:11908, 11861:11908, 12294:12378, 12294:12402, 12663:12733, 1…</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
<code>let</code> blocks
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>A <code>let/end</code> block provides a local namespace. The custom <code>lt</code> comparison method will not be visible outside the scope of the block.</p>
</div>
</div>
</div>
<ul>
<li>We will use the ranges on chromsome 1 for our timing benchmarks. The target for tests of intersection with a single target range will be the last range on chromosome 1 in “ex-rna.arrow”.</li>
</ul>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>refrngvec01 <span class="op">=</span> refrngvecs[<span class="op">:</span>chr01]</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>tarrngvec01 <span class="op">=</span> tarrngvecs[<span class="op">:</span>chr01]</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>target <span class="op">=</span> <span class="fu">last</span>(tarrngvec01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>182839365:182887745</code></pre>
</div>
</div>
</section>
</section>
<section id="intersecting-reference-ranges-with-a-target" class="level1">
<h1>Intersecting reference ranges with a target</h1>
<ul>
<li><p>Create a method to intersect a target range with a <code>Vector{UnitRange}</code> returning the intersections as another <code>Vector{UnitRange}</code>.</p></li>
<li><p>A common Julia programming idiom for such cases is to create two methods: one for <code>intersect!</code>, which modifies an argument that will hold the result, and one for <code>intersect</code>, which allocates the result then calls the <code>intersect!</code> method.</p></li>
<li><p>For the <code>intersect!</code> method we first <code>empty!</code> the result vector, which zeros the vector length but does not shrink the memory chunk allocated to the vector, then <code>push!</code> intersections onto it. If there are many calls to an <code>intersect!</code> method like this only a few will cause memory allocations.</p></li>
<li><p>The elements of our vectors of reference ranges, like <code>refrngvec01</code>, are sorted by their <code>first</code> element but globally the <code>last</code> elements do not have any special relationships. The best we can do to determine all intersections is a sequential scan of the sorted vector of ranges with an early exit when <code>last(target) &lt; first(vectorelement)</code>.</p></li>
</ul>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="bu">Base</span>.<span class="fu">intersect!</span>(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  result<span class="op">::</span><span class="dt">Vector{UnitRange{T}}</span>,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  target<span class="op">::</span><span class="dt">AbstractUnitRange{&lt;:Integer}</span>,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  refs<span class="op">::</span><span class="dt">Vector{UnitRange{T}}</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>) <span class="kw">where</span> {T}</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">empty!</span>(result)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  target <span class="op">=</span> <span class="fu">eltype</span>(refs)(target)  <span class="co"># coerce the type, if necessary</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  lastt <span class="op">=</span> <span class="fu">last</span>(target)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> rng <span class="kw">in</span> refs</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    lastt <span class="op">&lt;</span> <span class="fu">first</span>(rng) <span class="op">&amp;&amp;</span> <span class="cf">break</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    isect <span class="op">=</span> <span class="fu">intersect</span>(target, rng)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    !<span class="fu">isempty</span>(isect) <span class="op">&amp;&amp;</span> <span class="fu">push!</span>(result, isect)</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="bu">Base</span>.<span class="fu">intersect</span>(</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  target<span class="op">::</span><span class="dt">AbstractUnitRange{&lt;:Integer}</span>,</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  refs<span class="op">::</span><span class="dt">Vector{UnitRange{T}}</span>,</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>) <span class="kw">where</span> {T}</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">intersect!</span>(<span class="fu">similar</span>(refs, <span class="fl">0</span>), target, refs)</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>savedresult <span class="op">=</span> <span class="fu">intersect</span>(target, refrngvec01)  <span class="co"># will use for comparisons</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>44-element Vector{UnitRange{Int32}}:
 182839369:182839456
 182839734:182839935
 182842545:182842677
 182843294:182843434
 182852233:182852344
 182853306:182853418
 182854030:182854142
 182854030:182854178
 182854041:182854178
 182855577:182855713
 182856532:182856572
 182856532:182856578
 182858104:182858240
 ⋮
 182880497:182880608
 182881264:182881425
 182881285:182881425
 182881520:182881645
 182881520:182881647
 182883139:182883216
 182883139:182883368
 182883320:182883368
 182883520:182883635
 182884613:182884813
 182887083:182887745
 182887083:182887745</code></pre>
</div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> <span class="fu">similar</span>(refrngvec01, <span class="fl">0</span>)  <span class="co"># 0-length vector of same type</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">isequal</span>(<span class="fu">intersect!</span>(result, target, refrngvec01), savedresult)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>true</code></pre>
</div>
</div>
</section>
<section id="dictionaries-of-rangetrees-and-intervaltrees" class="level1">
<h1>Dictionaries of RangeTrees and IntervalTrees</h1>
<section id="rangetrees" class="level2">
<h2 class="anchored" data-anchor-id="rangetrees">RangeTrees</h2>
<ul>
<li><p><a href="https://github.com/dmbates/RangeTrees.jl">RangeTrees.jl</a> provides an implementation of <a href="https://en.wikipedia.org/wiki/Interval_tree">interval trees</a> using the <a href="https://en.wikipedia.org/wiki/Interval_tree#Augmented_tree">augmented binary tree</a> formulation.</p></li>
<li><p>Because the tree is represented by its root node, there is no <code>RangeTree</code> type or constructor, only a <code>RangeNode</code>.</p></li>
</ul>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>refrngtrees <span class="op">=</span> <span class="fu">Dict</span>(k <span class="op">=&gt;</span> <span class="fu">RangeNode</span>(v) <span class="cf">for</span> (k, v) <span class="kw">in</span> refrngvecs)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>rangetree01 <span class="op">=</span> refrngtrees[<span class="op">:</span>chr01]</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">treesize</span>(rangetree01), <span class="fu">treeheight</span>(rangetree01), <span class="fu">treebreadth</span>(rangetree01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>(52789, 15, 20022)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print_tree</span>(rangetree01; maxdepth<span class="op">=</span><span class="fl">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(110172080:110172489, 248937043)
├─ (37858488:37858539, 110172217)
│  ├─ (19100078:19100126, 37857709)
│  │  ├─ (7745845:7746091, 19099677)
│  │  │  ⋮
│  │  │  
│  │  └─ (27615689:27615844, 37857709)
│  │     ⋮
│  │     
│  └─ (62834038:62834116, 110172217)
│     ├─ (46194582:46194651, 62829176)
│     │  ⋮
│     │  
│     └─ (89633140:89633322, 110172217)
│        ⋮
│        
└─ (169855796:169855957, 248937043)
   ├─ (153545753:153545802, 169854964)
   │  ├─ (145901516:145901664, 153545518)
   │  │  ⋮
   │  │  
   │  └─ (157519743:157519770, 169854964)
   │     ⋮
   │     
   └─ (208028830:208030303, 248937043)
      ├─ (196793317:196793633, 208029042)
      │  ⋮
      │  
      └─ (228147615:228147699, 248937043)
         ⋮
         </code></pre>
</div>
</div>
<div class="callout-note callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Augmented interval trees
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>A smaller example may help to understand how this type of interval tree. Consider the first 7 <code>UnitRange</code>s in <code>refrngvecs[:chr01]</code></p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>smallrngvec <span class="op">=</span> refrngvecs[<span class="op">:</span>chr01][<span class="fl">1</span><span class="op">:</span><span class="fl">7</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>7-element Vector{UnitRange{Int32}}:
 11869:12227
 12010:12057
 12179:12227
 12613:12697
 12613:12721
 12975:13052
 13221:13374</code></pre>
</div>
</div>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>rn <span class="op">=</span> <span class="fu">RangeNode</span>(smallrngvec)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print_tree</span>(rn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(12613:12697, 13374)
├─ (12010:12057, 12227)
│  ├─ (11869:12227, 12227)
│  └─ (12179:12227, 12227)
└─ (12975:13052, 13374)
   ├─ (12613:12721, 12721)
   └─ (13221:13374, 13374)</code></pre>
</div>
</div>
<ul>
<li>The <code>UnitRange</code> in the root node is the 4th out of the 7 sorted ranges from which the tree was constructed.</li>
<li>Each of the nodes in the tree can have 0, 1, or 2 child nodes. Those with 0 children are called the “leaves” of the tree.</li>
</ul>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">collect</span>(<span class="fu">Leaves</span>(rn))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>4-element Vector{RangeNode{Int32, Int32}}:
 (11869:12227, 12227)
 (12179:12227, 12227)
 (12613:12721, 12721)
 (13221:13374, 13374)</code></pre>
</div>
</div>
<ul>
<li>In addition to the <code>UnitRange</code> it represents, each <code>RangeNode</code> stores <code>maxlast</code>, the maximum value of <code>last(rng)</code> for any <code>UnitRange</code> in the tree rooted at this node. For a leaf <code>maxlast</code> is simply <code>last</code> of its <code>UnitRange</code>.</li>
<li>For other nodes, <code>maxlast</code> can be larger than <code>last</code> of its <code>UnitRange</code>.</li>
<li>In particular, for the root node <code>maxlast</code> is the maximum of all the <code>last</code> values of the <code>UnitRange</code>s that generated the tree.</li>
</ul>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">maximum</span>(<span class="fu">last</span>.(smallrngvec))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>13374</code></pre>
</div>
</div>
<p><a href="https://github.com/dmbates/RangeTrees.jl">RangeTrees.jl</a> defines methods for generics like <code>children</code>, <code>getroot</code>, and <code>nodevalue</code> from <a href="https://github.com/JuliaCollections/AbstractTrees.jl">AbstractTrees.jl</a> and these allow for many other generics to be applied to a <code>RangeNode</code>.</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">children</span>(rangetree01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>2-element Vector{RangeNode{Int32, Int32}}:
 (37858488:37858539, 110172217)
 (169855796:169855957, 248937043)</code></pre>
</div>
</div>
<p>The root of the tree can be obtained from any node using <code>getroot</code>. The combination of <code>getroot</code> and <code>children</code> allows traversal of the tree.</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">getroot</span>(<span class="fu">first</span>(<span class="fu">children</span>(<span class="fu">first</span>(<span class="fu">children</span>(rangetree01))))) <span class="co"># get the root from its grandchild</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>(110172080:110172489, 248937043)</code></pre>
</div>
</div>
</div>
</div>
</div>
<ul>
<li><p>Evaluating and storing <code>maxlast</code> in the nodes allows for overlap searchs to be truncated at nodes for which <code>maxlast &lt; first(target)</code>. The sorting by <code>first</code> allows for skipping the right subtree whenever <code>last(target) &lt; first(thisnode)</code> (as in the <code>intersect!</code> method for <code>Vector{UnitRange}</code>).</p></li>
<li><p><code>intersect</code> and <code>intersect!</code> methods are already defined in <a href="https://github.com/dmbates/RangeTrees.jl">RangeTrees.jl</a>.</p></li>
<li><p>Check that their results agree with the saved result.</p></li>
</ul>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">isequal</span>(<span class="fu">intersect</span>(target, rangetree01), savedresult)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>true</code></pre>
</div>
</div>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">isequal</span>(<span class="fu">intersect!</span>(result, target, rangetree01), savedresult)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>true</code></pre>
</div>
</div>
</section>
<section id="intervaltrees" class="level2">
<h2 class="anchored" data-anchor-id="intervaltrees">IntervalTrees</h2>
<ul>
<li>Create a dictionary of <code>IntervalTree</code>s. It is somewhat tedious to get the type of the result correct and we create a function to hide the details.</li>
</ul>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toitrees</span>(rngdict<span class="op">::</span><span class="dt">Dict{S,Vector{UnitRange{T}}}</span>) <span class="kw">where</span> {S,T}</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">Dict</span>(</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=&gt;</span> <span class="fu">IntervalTree</span><span class="dt">{T,Interval{T}}</span>(<span class="fu">Interval</span>.(v)) <span class="cf">for</span> (k, v) <span class="kw">in</span> rngdict</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>refintvltrees <span class="op">=</span> <span class="fu">toitrees</span>(refrngvecs)</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>intvltree01 <span class="op">=</span> refintvltrees[<span class="op">:</span>chr01]</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="fu">show</span>(intvltree01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>IntervalTree{Int32, Interval{Int32}}
(11869,12227)
(12010,12057)
(12179,12227)
⋮
(248917279,248917401)
(248917279,248919946)
(248936581,248937043)</code></pre>
</div>
</div>
<ul>
<li>Creating an <code>intersect!</code> method is also tedious because the package has its own <code>Interval</code> data type and defines <code>intersect(itr::IntervalTree, (frst, lst))</code> to return an iterator of <code>Interval</code>s in the tree, not the intersection</li>
</ul>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Interval</span>(target)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>Interval{Int32}
(182839365,182887745)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="bu">Base</span>.<span class="fu">intersect!</span>(</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  res<span class="op">::</span><span class="dt">Vector{UnitRange{T}}</span>,</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  target<span class="op">::</span><span class="dt">AbstractUnitRange</span>,</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  refs<span class="op">::</span><span class="dt">IntervalTree{T}</span>,</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>) <span class="kw">where</span> {T}</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">empty!</span>(res)</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  firstt, lastt <span class="op">=</span> <span class="fu">first</span>(target), <span class="fu">last</span>(target)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> isect <span class="kw">in</span> <span class="fu">intersect</span>(refs, (firstt, lastt))</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">push!</span>(res, <span class="fu">max</span>(<span class="fu">first</span>(isect), firstt)<span class="op">:</span><span class="fu">min</span>(<span class="fu">last</span>(isect), lastt))</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> res</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="fu">isequal</span>(<span class="fu">intersect!</span>(result, target, intvltree01), savedresult)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>true</code></pre>
</div>
</div>
</section>
</section>
<section id="time-for-a-shootout" class="level1">
<h1>Time for a shootout</h1>
<section id="vectorunitrange" class="level3">
<h3 class="anchored" data-anchor-id="vectorunitrange">Vector{UnitRange}</h3>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">intersect!</span>(res, tar, ref) setup <span class="op">=</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  (res <span class="op">=</span> result; tar <span class="op">=</span> target; ref <span class="op">=</span> refrngvec01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<div class="ansi-escaped-output">
<pre>BenchmarkTools.Trial: 10000 samples with 1 evaluation.
 Range <span class="ansi-bright-black-fg">(</span><span class="ansi-cyan-fg ansi-bold">min</span> … <span class="ansi-magenta-fg">max</span><span class="ansi-bright-black-fg">):  </span><span class="ansi-cyan-fg ansi-bold">35.842 μs</span> … <span class="ansi-magenta-fg">82.966 μs</span>  <span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>min … max<span class="ansi-bright-black-fg">): </span>0.00% … 0.00%
 Time  <span class="ansi-bright-black-fg">(</span><span class="ansi-blue-fg ansi-bold">median</span><span class="ansi-bright-black-fg">):     </span><span class="ansi-blue-fg ansi-bold">37.193 μs              </span><span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>median<span class="ansi-bright-black-fg">):    </span>0.00%
 Time  <span class="ansi-bright-black-fg">(</span><span class="ansi-green-fg ansi-bold">mean</span> ± <span class="ansi-green-fg">σ</span><span class="ansi-bright-black-fg">):   </span><span class="ansi-green-fg ansi-bold">39.107 μs</span> ± <span class="ansi-green-fg"> 4.336 μs</span>  <span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>mean ± σ<span class="ansi-bright-black-fg">):  </span>0.00% ± 0.00%
  ▆ █<span class="ansi-blue-fg">▇</span>    <span class="ansi-green-fg">▁</span>▆▃▆▇▁▁    ▂                                        ▂
  █▃█<span class="ansi-blue-fg">█</span>▇▇██<span class="ansi-green-fg">█</span>████████▇▇██▅▆▅▃▁▃▃▃▁▁▁▁▃▁▁▁▁▁▃▁▁▁▁▁▃▁▁▁▁▁▁▁▃▆▆▄▄▄ █
  35.8 μs<span class="ansi-bright-black-fg">      </span><span class="ansi-bright-black-fg">Histogram: </span><span class="ansi-bright-black-fg ansi-bold">log(</span><span class="ansi-bright-black-fg">frequency</span><span class="ansi-bright-black-fg ansi-bold">)</span><span class="ansi-bright-black-fg"> by time</span>      60.9 μs <span class="ansi-bold">&lt;</span>
 Memory estimate<span class="ansi-bright-black-fg">: </span><span class="ansi-yellow-fg">0 bytes</span>, allocs estimate<span class="ansi-bright-black-fg">: </span><span class="ansi-yellow-fg">0</span>.</pre>
</div>
</div>
</div>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">intersect</span>(tar, ref) setup <span class="op">=</span> (tar <span class="op">=</span> target; ref <span class="op">=</span> refrngvec01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<div class="ansi-escaped-output">
<pre>BenchmarkTools.Trial: 10000 samples with 1 evaluation.
 Range <span class="ansi-bright-black-fg">(</span><span class="ansi-cyan-fg ansi-bold">min</span> … <span class="ansi-magenta-fg">max</span><span class="ansi-bright-black-fg">):  </span><span class="ansi-cyan-fg ansi-bold">35.879 μs</span> … <span class="ansi-magenta-fg">69.170 μs</span>  <span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>min … max<span class="ansi-bright-black-fg">): </span>0.00% … 0.00%
 Time  <span class="ansi-bright-black-fg">(</span><span class="ansi-blue-fg ansi-bold">median</span><span class="ansi-bright-black-fg">):     </span><span class="ansi-blue-fg ansi-bold">37.224 μs              </span><span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>median<span class="ansi-bright-black-fg">):    </span>0.00%
 Time  <span class="ansi-bright-black-fg">(</span><span class="ansi-green-fg ansi-bold">mean</span> ± <span class="ansi-green-fg">σ</span><span class="ansi-bright-black-fg">):   </span><span class="ansi-green-fg ansi-bold">38.093 μs</span> ± <span class="ansi-green-fg"> 2.122 μs</span>  <span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>mean ± σ<span class="ansi-bright-black-fg">):  </span>0.00% ± 0.00%
   ▇▂     ▁<span class="ansi-blue-fg"> </span>     <span class="ansi-green-fg"> </span>             █                               
  ▅██▂▁▂▅▆█<span class="ansi-blue-fg">▆</span>▃▂▂▃▄<span class="ansi-green-fg">▃</span>▂▂▂▂▁▁▁▁▁▁▁▁▁█▄▁▁▁▂▄▂▂▂▂▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁ ▂
  35.9 μs<span class="ansi-bright-black-fg">         Histogram: frequency by time</span>        44.4 μs <span class="ansi-bold">&lt;</span>
 Memory estimate<span class="ansi-bright-black-fg">: </span><span class="ansi-yellow-fg">1.92 KiB</span>, allocs estimate<span class="ansi-bright-black-fg">: </span><span class="ansi-yellow-fg">4</span>.</pre>
</div>
</div>
</div>
</section>
<section id="rangetree" class="level3">
<h3 class="anchored" data-anchor-id="rangetree">RangeTree</h3>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">intersect!</span>(res, tar, ref) setup <span class="op">=</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  (res <span class="op">=</span> result; tar <span class="op">=</span> target; ref <span class="op">=</span> rangetree01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<div class="ansi-escaped-output">
<pre>BenchmarkTools.Trial: 10000 samples with 199 evaluations.
 Range <span class="ansi-bright-black-fg">(</span><span class="ansi-cyan-fg ansi-bold">min</span> … <span class="ansi-magenta-fg">max</span><span class="ansi-bright-black-fg">):  </span><span class="ansi-cyan-fg ansi-bold">422.015 ns</span> … <span class="ansi-magenta-fg">813.719 ns</span>  <span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>min … max<span class="ansi-bright-black-fg">): </span>0.00% … 0.00%
 Time  <span class="ansi-bright-black-fg">(</span><span class="ansi-blue-fg ansi-bold">median</span><span class="ansi-bright-black-fg">):     </span><span class="ansi-blue-fg ansi-bold">427.648 ns               </span><span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>median<span class="ansi-bright-black-fg">):    </span>0.00%
 Time  <span class="ansi-bright-black-fg">(</span><span class="ansi-green-fg ansi-bold">mean</span> ± <span class="ansi-green-fg">σ</span><span class="ansi-bright-black-fg">):   </span><span class="ansi-green-fg ansi-bold">432.294 ns</span> ± <span class="ansi-green-fg"> 17.005 ns</span>  <span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>mean ± σ<span class="ansi-bright-black-fg">):  </span>0.00% ± 0.00%
    ▂█▇▂<span class="ansi-blue-fg"> </span>    <span class="ansi-green-fg"> </span>                                                   
  ▂▄████<span class="ansi-blue-fg">▇</span>▆▄▃▃<span class="ansi-green-fg">▃</span>▃▅▆▅▄▃▂▂▂▂▂▂▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁ ▂
  422 ns<span class="ansi-bright-black-fg">           Histogram: frequency by time</span>          480 ns <span class="ansi-bold">&lt;</span>
 Memory estimate<span class="ansi-bright-black-fg">: </span><span class="ansi-yellow-fg">0 bytes</span>, allocs estimate<span class="ansi-bright-black-fg">: </span><span class="ansi-yellow-fg">0</span>.</pre>
</div>
</div>
</div>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">intersect</span>(tar, ref) setup <span class="op">=</span> (tar <span class="op">=</span> target; ref <span class="op">=</span> rangetree01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<div class="ansi-escaped-output">
<pre>BenchmarkTools.Trial: 10000 samples with 192 evaluations.
 Range <span class="ansi-bright-black-fg">(</span><span class="ansi-cyan-fg ansi-bold">min</span> … <span class="ansi-magenta-fg">max</span><span class="ansi-bright-black-fg">):  </span><span class="ansi-cyan-fg ansi-bold">508.031 ns</span> … <span class="ansi-magenta-fg">63.024 μs</span>  <span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>min … max<span class="ansi-bright-black-fg">): </span> 0.00% … 98.31%
 Time  <span class="ansi-bright-black-fg">(</span><span class="ansi-blue-fg ansi-bold">median</span><span class="ansi-bright-black-fg">):     </span><span class="ansi-blue-fg ansi-bold">937.799 ns              </span><span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>median<span class="ansi-bright-black-fg">):    </span> 0.00%
 Time  <span class="ansi-bright-black-fg">(</span><span class="ansi-green-fg ansi-bold">mean</span> ± <span class="ansi-green-fg">σ</span><span class="ansi-bright-black-fg">):   </span><span class="ansi-green-fg ansi-bold">952.166 ns</span> ± <span class="ansi-green-fg"> 2.808 μs</span>  <span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>mean ± σ<span class="ansi-bright-black-fg">):  </span>13.48% ±  4.51%
  ▇▇▄▁                                   ▅█<span class="ansi-blue-fg">█</span><span class="ansi-green-fg">▇</span>▅▃▂               ▂
  ████████▇█▄▅▆▆▅▅▅▆▅▅▅▄▃▃▄▄▅▁▁▁▁▃▁▁▄▅▅▄███<span class="ansi-blue-fg">█</span><span class="ansi-green-fg">█</span>█████▇▇▇▆▆▇▇▇▇▇▆▇ █
  508 ns<span class="ansi-bright-black-fg">        </span><span class="ansi-bright-black-fg">Histogram: </span><span class="ansi-bright-black-fg ansi-bold">log(</span><span class="ansi-bright-black-fg">frequency</span><span class="ansi-bright-black-fg ansi-bold">)</span><span class="ansi-bright-black-fg"> by time</span>      1.14 μs <span class="ansi-bold">&lt;</span>
 Memory estimate<span class="ansi-bright-black-fg">: </span><span class="ansi-yellow-fg">1.92 KiB</span>, allocs estimate<span class="ansi-bright-black-fg">: </span><span class="ansi-yellow-fg">4</span>.</pre>
</div>
</div>
</div>
</section>
<section id="intervaltree" class="level3">
<h3 class="anchored" data-anchor-id="intervaltree">IntervalTree</h3>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">intersect!</span>(res, tar, ref) setup <span class="op">=</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  (res <span class="op">=</span> result; tar <span class="op">=</span> target; ref <span class="op">=</span> intvltree01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<div class="ansi-escaped-output">
<pre>BenchmarkTools.Trial: 10000 samples with 10 evaluations.
 Range <span class="ansi-bright-black-fg">(</span><span class="ansi-cyan-fg ansi-bold">min</span> … <span class="ansi-magenta-fg">max</span><span class="ansi-bright-black-fg">):  </span><span class="ansi-cyan-fg ansi-bold">1.270 μs</span> … <span class="ansi-magenta-fg"> 3.088 μs</span>  <span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>min … max<span class="ansi-bright-black-fg">): </span>0.00% … 0.00%
 Time  <span class="ansi-bright-black-fg">(</span><span class="ansi-blue-fg ansi-bold">median</span><span class="ansi-bright-black-fg">):     </span><span class="ansi-blue-fg ansi-bold">1.302 μs              </span><span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>median<span class="ansi-bright-black-fg">):    </span>0.00%
 Time  <span class="ansi-bright-black-fg">(</span><span class="ansi-green-fg ansi-bold">mean</span> ± <span class="ansi-green-fg">σ</span><span class="ansi-bright-black-fg">):   </span><span class="ansi-green-fg ansi-bold">1.313 μs</span> ± <span class="ansi-green-fg">75.633 ns</span>  <span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>mean ± σ<span class="ansi-bright-black-fg">):  </span>0.00% ± 0.00%
       ▁▅▇█▇<span class="ansi-blue-fg">▄</span>▁ <span class="ansi-green-fg"> </span>                                              
  ▂▂▃▅▆█████<span class="ansi-blue-fg">█</span>██<span class="ansi-green-fg">▇</span>██▆▅▄▄▃▃▃▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▁▂▂▂▂▂▂▂▂▂▂ ▃
  1.27 μs<span class="ansi-bright-black-fg">        Histogram: frequency by time</span>        1.46 μs <span class="ansi-bold">&lt;</span>
 Memory estimate<span class="ansi-bright-black-fg">: </span><span class="ansi-yellow-fg">80 bytes</span>, allocs estimate<span class="ansi-bright-black-fg">: </span><span class="ansi-yellow-fg">3</span>.</pre>
</div>
</div>
</div>
<ul>
<li>In what follows we will use the <code>RangeTree</code> method for <code>intersect!</code> to obtain the intersections.</li>
</ul>
</section>
</section>
<section id="determining-coverage" class="level1">
<h1>Determining coverage</h1>
<ul>
<li><p>The <code>coverage</code> of a target by a set of reference ranges is the proportion of the base pairs in the target that intersect with one or more of the reference ranges.</p></li>
<li><p>We need to somehow count the number of elements in the union of the ranges returned from <code>intersect!</code>.</p></li>
<li><p>This could be done using the <code>union!</code> method for a <a href="https://docs.julialang.org/en/v1/base/collections/#Base.BitSet">BitSet</a> but that approach has two problems: it is comparatively slow and, in Julia versions up to 1.8.0-rc1, it can be wrong.</p></li>
</ul>
<div class="callout-note callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Bug in <code>union!</code> for <code>BitSet</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><p>While creating these notes we discovered a <a href="https://github.com/JuliaLang/julia/pull/45574">bug</a> in the <code>union!</code> method for a <code>BitSet</code> and a <code>UnitRange</code>.</p></li>
<li><p>There was a <a href="https://github.com/JuliaLang/julia/pull/45578">PR</a> to fix it the next morning.</p></li>
<li><p>Versions of Julia prior to 1.8.0-rc2 can (and probably will) return incorrect values of coverage.</p></li>
<li><p>Replacing <code>union!(bs, isect)</code> by <code>union!(bs, BitSet(isect))</code> avoids this “infelicity” at the expense of more memory usage and compute time.</p></li>
</ul>
</div>
</div>
</div>
<ul>
<li><p>There is a better method that takes advantage of the intersecting ranges being sorted by <code>first</code></p></li>
<li><p>The idea is to “keep moving the goalposts”. When evaluating the coverage count, add the length of the current reference range’s intersection with only the part to the right of what has already been covered. The thing we know about the intersecting ranges is that each successive ranges’s <code>first</code> position is greater than or equal to the <code>first</code> position of all the ranges preceding it. That is, the ranges can’t “move left” as we iterate through them.</p></li>
</ul>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">coveragecount</span>(</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  target<span class="op">::</span><span class="dt">AbstractUnitRange</span>,</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  isects<span class="op">::</span><span class="dt">Vector{UnitRange{T}}</span>,</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>) <span class="kw">where</span> {T}</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  goalposts <span class="op">=</span> <span class="fu">eltype</span>(isects)(target) <span class="co"># coerce the type, if necessary</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>  rightpost <span class="op">=</span> <span class="fu">last</span>(goalposts)</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>  coverage <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> isect <span class="kw">in</span> isects</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    coverage <span class="op">+=</span> <span class="fu">length</span>(<span class="fu">intersect</span>(goalposts, isect))</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>    goalposts <span class="op">=</span> (<span class="fu">last</span>(isect) <span class="op">+</span> <span class="fu">one</span>(T))<span class="op">:</span>rightpost</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> coverage</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a><span class="fu">coveragecount</span>(target, savedresult)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>5639</code></pre>
</div>
</div>
</section>
<section id="iterating-over-a-collection-of-targets" class="level1">
<h1>Iterating over a collection of targets</h1>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">overlaps</span>(targets<span class="op">::</span><span class="dt">Vector{UnitRange{T}}</span>, refs<span class="op">::</span><span class="dt">RangeNode{T}</span>) <span class="kw">where</span> {T}</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  ntargets <span class="op">=</span> <span class="fu">length</span>(targets)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  nover <span class="op">=</span> <span class="fu">sizehint!</span>(<span class="dt">Int</span>[], ntargets)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  covcount <span class="op">=</span> <span class="fu">sizehint!</span>(T[], ntargets)</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  result <span class="op">=</span> <span class="fu">similar</span>(targets, <span class="fu">ceil</span>(<span class="dt">Int</span>, <span class="fu">sqrt</span>(<span class="fu">treesize</span>(refs))))</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> tar <span class="kw">in</span> targets</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">push!</span>(nover, <span class="fu">length</span>(<span class="fu">intersect!</span>(result, tar, refs)))</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">push!</span>(covcount, <span class="fu">coveragecount</span>(tar, result))</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">DataFrame</span>(targets <span class="op">=</span> targets, nover <span class="op">=</span> nover, covcount <span class="op">=</span> covcount)</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a><span class="fu">overlaps</span>(tarrngvec01, rangetree01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">

<div class="data-frame"><p>453,114 rows × 3 columns</p><table class="data-frame table table-sm table-striped"><thead><tr><th></th><th>targets</th><th>nover</th><th>covcount</th></tr><tr><th></th><th title="UnitRange{Int32}">UnitRang…</th><th title="Int64">Int64</th><th title="Int32">Int32</th></tr></thead><tbody><tr><th>1</th><td>165655371:165655620</td><td>3</td><td>250</td></tr><tr><th>2</th><td>84498368:84506172</td><td>6</td><td>676</td></tr><tr><th>3</th><td>44777749:44778638</td><td>11</td><td>944</td></tr><tr><th>4</th><td>23692611:23696418</td><td>9</td><td>1398</td></tr><tr><th>5</th><td>23692608:23696418</td><td>9</td><td>1401</td></tr><tr><th>6</th><td>23962516:23963450</td><td>1</td><td>935</td></tr><tr><th>7</th><td>23692686:23696419</td><td>9</td><td>1324</td></tr><tr><th>8</th><td>114717978:114720613</td><td>15</td><td>1127</td></tr><tr><th>9</th><td>116392931:116404775</td><td>19</td><td>2762</td></tr><tr><th>10</th><td>25567642:25568695</td><td>2</td><td>1054</td></tr><tr><th>11</th><td>23961575:23962496</td><td>2</td><td>922</td></tr><tr><th>12</th><td>8861023:8870500</td><td>14</td><td>1777</td></tr><tr><th>13</th><td>96678807:96679446</td><td>1</td><td>573</td></tr><tr><th>14</th><td>37536543:37554276</td><td>12</td><td>4139</td></tr><tr><th>15</th><td>155308882:155320663</td><td>56</td><td>5929</td></tr><tr><th>16</th><td>65230872:65232127</td><td>2</td><td>1256</td></tr><tr><th>17</th><td>23692609:23696399</td><td>9</td><td>1381</td></tr><tr><th>18</th><td>181089237:181090826</td><td>1</td><td>1590</td></tr><tr><th>19</th><td>185118995:185120707</td><td>4</td><td>1602</td></tr><tr><th>20</th><td>203861621:203870081</td><td>15</td><td>1134</td></tr><tr><th>21</th><td>153990779:153992127</td><td>10</td><td>903</td></tr><tr><th>22</th><td>42658437:42676757</td><td>19</td><td>1431</td></tr><tr><th>23</th><td>2309508:2310113</td><td>1</td><td>606</td></tr><tr><th>24</th><td>173863895:173866795</td><td>42</td><td>6089</td></tr><tr><th>25</th><td>209768622:209782307</td><td>33</td><td>8753</td></tr><tr><th>26</th><td>45511237:45521873</td><td>15</td><td>2955</td></tr><tr><th>27</th><td>8861009:8861287</td><td>2</td><td>279</td></tr><tr><th>28</th><td>43974941:43978232</td><td>32</td><td>3868</td></tr><tr><th>29</th><td>89052317:89052623</td><td>1</td><td>305</td></tr><tr><th>30</th><td>109593271:109593512</td><td>1</td><td>242</td></tr><tr><th>⋮</th><td>⋮</td><td>⋮</td><td>⋮</td></tr></tbody></table></div>
</div>
</div>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">overlaps</span>(targets, refs) setup <span class="op">=</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  (targets <span class="op">=</span> tarrngvec01; refs <span class="op">=</span> rangetree01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<div class="ansi-escaped-output">
<pre>BenchmarkTools.Trial: 37 samples with 1 evaluation.
 Range <span class="ansi-bright-black-fg">(</span><span class="ansi-cyan-fg ansi-bold">min</span> … <span class="ansi-magenta-fg">max</span><span class="ansi-bright-black-fg">):  </span><span class="ansi-cyan-fg ansi-bold">134.859 ms</span> … <span class="ansi-magenta-fg">147.640 ms</span>  <span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>min … max<span class="ansi-bright-black-fg">): </span>0.00% … 0.00%
 Time  <span class="ansi-bright-black-fg">(</span><span class="ansi-blue-fg ansi-bold">median</span><span class="ansi-bright-black-fg">):     </span><span class="ansi-blue-fg ansi-bold">137.334 ms               </span><span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>median<span class="ansi-bright-black-fg">):    </span>0.00%
 Time  <span class="ansi-bright-black-fg">(</span><span class="ansi-green-fg ansi-bold">mean</span> ± <span class="ansi-green-fg">σ</span><span class="ansi-bright-black-fg">):   </span><span class="ansi-green-fg ansi-bold">138.433 ms</span> ± <span class="ansi-green-fg">  3.714 ms</span>  <span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>mean ± σ<span class="ansi-bright-black-fg">):  </span>0.86% ± 2.10%
   ▂  █      <span class="ansi-blue-fg">▂</span>     <span class="ansi-green-fg"> </span>                                             
  ███▁█▅▅▅▁▁▅<span class="ansi-blue-fg">█</span>▅██▁▅<span class="ansi-green-fg">▁</span>█▅▁▅▅▁▁▁▁▁▁▁▅▁▁▁▁▁▁▁▁▁▁▁▁▁▁█▁▁▁▁▁▁▅▁▁▅▁▁▅▁▅ ▁
  135 ms<span class="ansi-bright-black-fg">           Histogram: frequency by time</span>          148 ms <span class="ansi-bold">&lt;</span>
 Memory estimate<span class="ansi-bright-black-fg">: </span><span class="ansi-yellow-fg">26.23 MiB</span>, allocs estimate<span class="ansi-bright-black-fg">: </span><span class="ansi-yellow-fg">158533</span>.</pre>
</div>
</div>
</div>
</section>
<section id="the-whole-shootin-match" class="level1">
<h1>The whole shootin’ match</h1>
<ul>
<li>The computations on different chromosome are independent of each other and can be assigned to different threads when Julia is started with multiple threads.</li>
</ul>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">overlaps</span>(</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  tardict<span class="op">::</span><span class="dt">Dict{Symbol,Vector{UnitRange{T}}}</span>,</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  refdict<span class="op">::</span><span class="dt">Dict{Symbol,RangeNode{T,R}}</span>,</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>) <span class="kw">where</span> {T,R}</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  matchedkeys <span class="op">=</span> <span class="fu">intersect</span>(<span class="fu">keys</span>(tardict), <span class="fu">keys</span>(refdict))</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>  result <span class="op">=</span> <span class="fu">Dict</span>(k <span class="op">=&gt;</span> <span class="fu">DataFrame</span>() <span class="cf">for</span> k <span class="kw">in</span> matchedkeys) <span class="co"># pre-assign key/value pairs</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>  <span class="pp">@sync</span> <span class="cf">for</span> k <span class="kw">in</span> matchedkeys</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Threads</span>.<span class="pp">@spawn</span> result[k] <span class="op">=</span> <span class="fu">overlaps</span>(tardict[k], refdict[k])</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>bigresult <span class="op">=</span> <span class="fu">overlaps</span>(tarrngvecs, refrngtrees);</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>bigresult[<span class="op">:</span>chrY]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">

<div class="data-frame"><p>89 rows × 3 columns</p><table class="data-frame table table-sm table-striped"><thead><tr><th></th><th>targets</th><th>nover</th><th>covcount</th></tr><tr><th></th><th title="UnitRange{Int32}">UnitRang…</th><th title="Int64">Int64</th><th title="Int32">Int32</th></tr></thead><tbody><tr><th>1</th><td>13286599:13287476</td><td>1</td><td>741</td></tr><tr><th>2</th><td>13286598:13287541</td><td>1</td><td>741</td></tr><tr><th>3</th><td>13286599:13287542</td><td>1</td><td>741</td></tr><tr><th>4</th><td>13286648:13287509</td><td>1</td><td>731</td></tr><tr><th>5</th><td>13286679:13287469</td><td>1</td><td>700</td></tr><tr><th>6</th><td>5793260:5793463</td><td>1</td><td>164</td></tr><tr><th>7</th><td>5793274:5793472</td><td>1</td><td>173</td></tr><tr><th>8</th><td>10200166:10200308</td><td>1</td><td>141</td></tr><tr><th>9</th><td>13287196:13287541</td><td>1</td><td>183</td></tr><tr><th>10</th><td>18992142:18992375</td><td>0</td><td>0</td></tr><tr><th>11</th><td>18992104:18992424</td><td>0</td><td>0</td></tr><tr><th>12</th><td>24362036:24362135</td><td>0</td><td>0</td></tr><tr><th>13</th><td>13287300:13287543</td><td>1</td><td>79</td></tr><tr><th>14</th><td>18992170:18992298</td><td>0</td><td>0</td></tr><tr><th>15</th><td>13286570:13287469</td><td>1</td><td>741</td></tr><tr><th>16</th><td>13286566:13287413</td><td>1</td><td>741</td></tr><tr><th>17</th><td>13287043:13287440</td><td>1</td><td>336</td></tr><tr><th>18</th><td>11336248:11442584</td><td>15</td><td>4284</td></tr><tr><th>19</th><td>13286619:13287467</td><td>1</td><td>741</td></tr><tr><th>20</th><td>13286571:13287542</td><td>1</td><td>741</td></tr><tr><th>21</th><td>13286659:13287547</td><td>1</td><td>720</td></tr><tr><th>22</th><td>13286587:13287543</td><td>1</td><td>741</td></tr><tr><th>23</th><td>5793255:5793467</td><td>1</td><td>168</td></tr><tr><th>24</th><td>13287260:13287542</td><td>1</td><td>119</td></tr><tr><th>25</th><td>13286762:13287408</td><td>1</td><td>617</td></tr><tr><th>26</th><td>13286725:13287522</td><td>1</td><td>654</td></tr><tr><th>27</th><td>5337673:5338106</td><td>1</td><td>362</td></tr><tr><th>28</th><td>13286617:13287543</td><td>1</td><td>741</td></tr><tr><th>29</th><td>18992107:18992666</td><td>1</td><td>200</td></tr><tr><th>30</th><td>13286699:13287435</td><td>1</td><td>680</td></tr><tr><th>⋮</th><td>⋮</td><td>⋮</td><td>⋮</td></tr></tbody></table></div>
</div>
</div>
<div class="callout-note callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-10-contents" aria-controls="callout-10" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Pre-assigning dictionary entries to avoid thread conflict
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-10" class="callout-10-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li>The <code>result</code> is initialized with all the keys that will be in the result and with values that are empty <code>DataFrame</code>s.</li>
<li>Individual tasks that are <code>@spawn</code>ed allocate their <code>DataFrame</code> value and merely update the pointer in <code>result</code> to that value, eliminating the possibility of collisions with other tasks.</li>
</ul>
</div>
</div>
</div>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">overlaps</span>(targets, refs) setup <span class="op">=</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  (targets <span class="op">=</span> tarrngvecs; refs <span class="op">=</span> refrngtrees)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<div class="ansi-escaped-output">
<pre>BenchmarkTools.Trial: 11 samples with 1 evaluation.
 Range <span class="ansi-bright-black-fg">(</span><span class="ansi-cyan-fg ansi-bold">min</span> … <span class="ansi-magenta-fg">max</span><span class="ansi-bright-black-fg">):  </span><span class="ansi-cyan-fg ansi-bold">422.168 ms</span> … <span class="ansi-magenta-fg">639.266 ms</span>  <span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>min … max<span class="ansi-bright-black-fg">): </span>0.00% … 13.09%
 Time  <span class="ansi-bright-black-fg">(</span><span class="ansi-blue-fg ansi-bold">median</span><span class="ansi-bright-black-fg">):     </span><span class="ansi-blue-fg ansi-bold">475.697 ms               </span><span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>median<span class="ansi-bright-black-fg">):    </span>0.00%
 Time  <span class="ansi-bright-black-fg">(</span><span class="ansi-green-fg ansi-bold">mean</span> ± <span class="ansi-green-fg">σ</span><span class="ansi-bright-black-fg">):   </span><span class="ansi-green-fg ansi-bold">486.962 ms</span> ± <span class="ansi-green-fg"> 62.592 ms</span>  <span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>mean ± σ<span class="ansi-bright-black-fg">):  </span>2.90% ±  5.25%
  ▁  ▁  ▁  <span class="ansi-blue-fg">█</span>     ▁ ▁<span class="ansi-green-fg">▁</span> ▁                 ▁                     ▁  
  █▁▁█▁▁█▁▁<span class="ansi-blue-fg">█</span>▁▁▁▁▁█▁█<span class="ansi-green-fg">█</span>▁█▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁█▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁█ ▁
  422 ms<span class="ansi-bright-black-fg">           Histogram: frequency by time</span>          639 ms <span class="ansi-bold">&lt;</span>
 Memory estimate<span class="ansi-bright-black-fg">: </span><span class="ansi-yellow-fg">278.21 MiB</span>, allocs estimate<span class="ansi-bright-black-fg">: </span><span class="ansi-yellow-fg">1724563</span>.</pre>
</div>
</div>
</div>
</section>
<section id="conclusions" class="level1">
<h1>Conclusions</h1>
<ul>
<li>The ability to work in the REPL (or VS Code or Jupyter notebooks) encourages iterative refinement of algorithms.</li>
<li>“Trust but verify” - when making a change or introducing new methods it helps to have results from previous methods for comparison. In general, continuous integration (CI) testing is straightforward for Julia packages and is strongly encouraged.</li>
<li>There are many tools for benchmarking function execution or storage allocation, allowing a developer to concentrate on where the “real problem” is.</li>
<li>In certain cases, enhancements like multi-threading can be achieved with very little effort.</li>
</ul>
</section>
<section id="version-information" class="level1">
<h1>Version information</h1>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">versioninfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Julia Version 1.8.0-rc1
Commit 6368fdc656 (2022-05-27 18:33 UTC)
Platform Info:
  OS: Linux (x86_64-pc-linux-gnu)
  CPU: 8 × 11th Gen Intel(R) Core(TM) i5-1135G7 @ 2.40GHz
  WORD_SIZE: 64
  LIBM: libopenlibm
  LLVM: libLLVM-13.0.1 (ORCJIT, tigerlake)
  Threads: 6 on 8 virtual cores</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>

<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./session2a-tables-and-arrow.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Session 2a: Data Tables and Arrow files</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./session4-exercise.html" class="pagination-link">
        <span class="nav-page-text">Session 4: Hands-on exercise</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>